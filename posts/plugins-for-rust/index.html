<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><link href="https://fonts.googleapis.com/css?family=Open+Sans:400|Old+Standard+TT:400" rel=stylesheet type=text/css><link rel=icon type=image/png href=https://reorchestrate.com/favicon_16x16.png sizes=16x16><link rel=icon type=image/png href=https://reorchestrate.com/favicon_32x32.png sizes=32x32><link rel=icon type=image/png href=https://reorchestrate.com/favicon_128x128.png sizes=128x128><title>Plugins for Rust</title><link rel=canonical href=https://reorchestrate.com/posts/plugins-for-rust/><style>*{border:0;font:inherit;font-size:100%;vertical-align:baseline;margin:0;padding:0;color:#000;text-decoration-skip:ink}body{font-family:open sans,myriad pro,Myriad,sans-serif;font-size:17px;-webkit-font-smoothing:antialiased;line-height:160%;color:#1d1313;max-width:950px;margin:auto}p{margin:20px 0}a img{border:none}img{margin:10px auto;max-width:100%;display:block}.left-justify{float:left}.right-justify{float:right}pre,code{font:12px Consolas,liberation mono,Menlo,Courier,monospace;background-color:#f7f7f7}code{font-size:12px;padding:4px}pre{margin-top:0;margin-bottom:16px;word-wrap:normal;padding:16px;overflow:auto;font-size:85%;line-height:1.45}pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:#0000;border:0}pre code::before,pre code::after{content:normal}em,q,em,dfn{font-style:italic}.sans,html .gist .gist-file .gist-meta{font-family:open sans,myriad pro,Myriad,sans-serif}.mono,pre,code,tt,p code,li code{font-family:Menlo,Monaco,andale mono,lucida console,courier new,monospace}.heading,.serif,h1,h2,h3,h4,h5{font-family:old standard tt,serif}strong{font-weight:600}table{width:100%}thead{font-weight:800;background:#dadada}tbody tr:nth-child(even){background:#f7f7f7}table td,th{padding:2px}q:before{content:"\201C"}q:after{content:"\201D"}del,s{text-decoration:line-through}blockquote{font-family:old standard tt,serif;text-align:center;padding:50px}blockquote p{display:inline-block;font-style:italic}blockquote:before,blockquote:after{font-family:old standard tt,serif;content:'\201C';font-size:35px;color:#403c3b}blockquote:after{content:'\201D'}hr{width:40%;height:1px;background:#403c3b;margin:25px auto}h1{font-weight:700;font-size:35px}h2{font-weight:700;font-size:28px}h3{font-weight:700;font-size:22px;margin-top:28px}h4{font-weight:700;font-size:20px;margin-top:20px}h5{font-size:18px;margin-top:18px}h1 a,h2 a,h3 a,h4 a,h5 a{text-decoration:none}h1,h2{margin-top:28px}#sub-header,time{color:#403c3b;font-size:13px}#sub-header{margin:0 4px}#nav h1 a{font-size:35px;color:#1d1313;line-height:120%}.posts_listing a,#nav a{text-decoration:none}li{margin-left:20px}ul li{margin-left:5px}ul li{list-style-type:none}ul li:before{content:"\00BB \0020"}#nav ul li:before,.posts_listing li:before{content:'';margin-right:0}#content{text-align:left;width:100%;font-size:15px;padding:60px 0 80px}#content h1,#content h2{margin-bottom:5px}#content h2{font-size:25px}#content .entry-content{margin-top:15px}#content time{margin-left:3px}#content h1{font-size:30px}.highlight{margin:10px 0}.posts_listing{margin:0 0 50px}.posts_listing li{margin:0 0 25px 15px}.posts_listing li a:hover,#nav a:hover{text-decoration:underline}#nav{text-align:center;position:static;margin-top:60px}#nav ul{display:table;margin:8px auto 0}#nav li{list-style-type:none;display:table-cell;font-size:15px;padding:0 20px}#source{margin:50px 0 0}#links{margin:50px 0 0}#links :nth-child(2){float:right}#not-found{text-align:center}#not-found a{font-family:old standard tt,serif;font-size:200px;text-decoration:none;display:inline-block;padding-top:225px}#nav .sub{font-size:80%;display:inline-block;vertical-align:middle}#nav .sub p{color:#403c3b;margin:0}#nav .sub a{text-decoration:none}#nav .sub svg{fill:#403c3b;display:inline-block;vertical-align:middle;padding-bottom:3px;padding-right:5px}@media(max-width:750px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:28px}#nav li{font-size:13px;padding:0 15px}#content{margin-top:0;padding-top:50px;font-size:14px}#content h1{font-size:25px}#content h2{font-size:22px}.posts_listing li div{font-size:12px}}@media(max-width:400px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:22px}#nav li{font-size:12px;padding:0 10px}#content{margin-top:0;padding-top:20px;font-size:12px}#content h1{font-size:20px}#content h2{font-size:18px}.posts_listing li div{font-size:12px}}.chroma{background-color:#f0f0f0}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em}.chroma .ln{margin-right:.4em;padding:0 .4em}.chroma .k{color:#007020;font-weight:700}.chroma .kc{color:#007020;font-weight:700}.chroma .kd{color:#007020;font-weight:700}.chroma .kn{color:#007020;font-weight:700}.chroma .kp{color:#007020}.chroma .kr{color:#007020;font-weight:700}.chroma .kt{color:#902000}.chroma .na{color:#4070a0}.chroma .nb{color:#007020}.chroma .nc{color:#0e84b5;font-weight:700}.chroma .no{color:#60add5}.chroma .nd{color:#555;font-weight:700}.chroma .ni{color:#d55537;font-weight:700}.chroma .ne{color:#007020}.chroma .nf{color:#06287e}.chroma .nl{color:#002070;font-weight:700}.chroma .nn{color:#0e84b5;font-weight:700}.chroma .nt{color:#062873;font-weight:700}.chroma .nv{color:#bb60d5}.chroma .s{color:#4070a0}.chroma .sa{color:#4070a0}.chroma .sb{color:#4070a0}.chroma .sc{color:#4070a0}.chroma .dl{color:#4070a0}.chroma .sd{color:#4070a0;font-style:italic}.chroma .s2{color:#4070a0}.chroma .se{color:#4070a0;font-weight:700}.chroma .sh{color:#4070a0}.chroma .si{color:#70a0d0;font-style:italic}.chroma .sx{color:#c65d09}.chroma .sr{color:#235388}.chroma .s1{color:#4070a0}.chroma .ss{color:#517918}.chroma .m{color:#40a070}.chroma .mb{color:#40a070}.chroma .mf{color:#40a070}.chroma .mh{color:#40a070}.chroma .mi{color:#40a070}.chroma .il{color:#40a070}.chroma .mo{color:#40a070}.chroma .o{color:#666}.chroma .ow{color:#007020;font-weight:700}.chroma .c{color:#60a0b0;font-style:italic}.chroma .ch{color:#60a0b0;font-style:italic}.chroma .cm{color:#60a0b0;font-style:italic}.chroma .c1{color:#60a0b0;font-style:italic}.chroma .cs{color:#60a0b0;background-color:#fff0f0}.chroma .cp{color:#007020}.chroma .cpf{color:#007020}.chroma .gd{color:#a00000}.chroma .ge{font-style:italic}.chroma .gr{color:red}.chroma .gh{color:navy;font-weight:700}.chroma .gi{color:#00a000}.chroma .go{color:#888}.chroma .gp{color:#c65d09;font-weight:700}.chroma .gs{font-weight:700}.chroma .gu{color:purple;font-weight:700}.chroma .gt{color:#04d}.chroma .w{color:#bbb}</style></head><body><section id=nav><h1><a href=https://reorchestrate.com/>reorchestrate</a></h1><section class=section><div class=sub><p>&copy; Mike Seddon 2023 |
<a href=https://www.github.com/seddonm1 target=_blank><svg width="22" height="22" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M896 128q209 0 385.5 103T1561 510.5 1664 896q0 251-146.5 451.5T1139 1625q-27 5-40-7t-13-30q0-3 .5-76.5t.5-134.5q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105T1386 856q0-119-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27T578 459.5 493 446q-45 113-8 204-79 87-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-39 36-49 103-21 10-45 15t-57 5-65.5-21.5T484 1274q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 88.5t.5 54.5q0 18-13 30t-40 7q-232-77-378.5-277.5T128 896q0-209 103-385.5T510.5 231 896 128zM419 1231q3-7-7-12-10-3-13 2-3 7 7 12 9 6 13-2zm31 34q7-5-2-16-10-9-16-3-7 5 2 16 10 10 16 3zm30 45q9-7 0-19-8-13-17-6-9 5 0 18t17 7zm42 42q8-8-4-19-12-12-20-3-9 8 4 19 12 12 20 3zm57 25q3-11-13-16-15-4-19 7t13 15q15 6 19-6zm63 5q0-13-17-11-16 0-16 11 0 13 17 11 16 0 16-11zm58-10q-2-11-18-9-16 3-14 15t18 8 14-14z"/></svg></a><a href=https://www.linkedin.com/in/mikeseddonau/ target=_blank><svg width="22" height="22" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M365 1414h231V720H365v694zm246-908q-1-52-36-86t-93-34-94.5 34-36.5 86q0 51 35.5 85.5T479 626h1q59 0 95-34.5t36-85.5zm585 908h231v-398q0-154-73-233t-193-79q-136 0-209 117h2V720H723q3 66 0 694h231v-388q0-38 7-56 15-35 45-59.5t74-24.5q116 0 116 157v371zm468-998v960q0 119-84.5 203.5T1376 1664H416q-119 0-203.5-84.5T128 1376V416q0-119 84.5-203.5T416 128h960q119 0 203.5 84.5T1664 416z"/></svg></a></p></div></section><ul></ul></section><section id=content><h1>Plugins for Rust</h1><div id=sub-header>27 January 2023</div><div class=entry-content><p>Plugins are a useful way to allow advanced users to add new functions your software without having to modify the main program itself. With <a href=https://en.wikipedia.org/wiki/Interpreter_(computing)>interpreted languages</a> like JavaScript or Python this can be relatively easy as the runtime itself is able to execute arbitrary instructions without them having to be compiled first. Rust is a compiled lanaguage so does not have a method of executing abritrary instructions prior to compilation so adding functions generally requires rewriting them in Rust and redeploying the binary.</p><p>So while interpreted languages are very convenient for executing arbitrary code (* written in the same language) this is not without risk as these commands are often executed in the same security context as the host and could potentially execute malicious code or access resources they should not.</p><p>With that in mind, my ideal requirements for a plugin system are:</p><ul><li>A user is able to execute arbitrary code provided in a language that is relatively well known/popular.</li><li>Code is executed in a sandbox so users cannot access resources that are not explicitly granted.</li><li>The code is executed at a <em>reasonable</em> level of performance - where <em>reasonable</em> depends on the use case.</li></ul><p>While a lot of <a href=https://nullderef.com/blog/plugin-tech/>excellent articles</a> have been written on the topic the purpose of this post is to explore the performance of a WebAssembly and specifically a <a href=https://wasi.dev/>WebAssembly System Interface</a> (WASI) approach.</p><h1 id=webassembly-and-webassembly-system-interface>WebAssembly and WebAssembly System Interface</h1><p>Despite the name, <a href=https://en.wikipedia.org/wiki/WebAssembly>WebAssembly</a> is better thought of as a portable binary-code format that can produced by many languages and run in a virtual machine - the <code>Web</code> part is a bit of a misnomer as browsers have just one implementation of the virtual machine. Rust already has an excellent and well supported library <a href=https://github.com/bytecodealliance/wasmtime>wasmtime</a> that implements a virtual machine/sandbox that is able to interpet a compiled <code>WASM</code> module and execute it. <code>wasmtime</code> also implements the <a href=https://wasi.dev/>WebAssembly System Interface</a> specification allowing explicit permissions to access host resources such as access to the host filesystem.</p><h1 id=arbitrary-code-execution>Arbitrary Code Execution</h1><p>To meet the first requirement, arbitrary code execution, we need some sort of interpreter that is able to be run within the Rust binary and be called with an instruction provided by the user that it executes and returns a response - a <a href=https://en.wikipedia.org/wiki/Scripting_language>scripting language</a>. While it is tempting to consider a language like <a href=https://en.wikipedia.org/wiki/Lua_(programming_language)>Lua</a> which is almost ideal for this purpose instead I am limiting this search to either <a href=https://en.wikipedia.org/wiki/Python_(programming_language)>Python</a> or <a href=https://en.wikipedia.org/wiki/JavaScript>JavaScript</a> both due to their ubiquity (extremly easy to find developers) and easy integration with WebAssembly.</p><p>Whilst Python is now able to be built for WebAssembly (see <a href=https://github.com/singlestore-labs/python-wasi/>https://github.com/singlestore-labs/python-wasi/</a>) it is an extremely large binary (the binary Python 3.11 WASM file is more than 100MB).</p><p>Instead I am focusing on a comparatively tiny JavaScript interpreter called <a href=https://bellard.org/quickjs/>QuickJS</a> which is relatively tiny at ~1MB and still passes <a href=https://test262.report/>nearly 100%</a> of the ECMAScript Test Suite. <a href=https://www.shopify.com/>Shopify</a>, via the <a href=https://github.com/Shopify/javy>javy</a> project have created excellent Rust bindings <a href=https://github.com/Shopify/javy/tree/main/crates/quickjs-wasm-sys>quickjs-wasm-sys</a> and <a href=https://github.com/Shopify/javy/tree/main/crates/quickjs-wasm-rs>quickjs-wasm-rs</a> which allow <code>QuickJS</code> to be build for the <code>WASI</code> target with minimal effort and, as we will explore below, offer some additional useful features for interacting with QuickJS.</p><h1 id=performance>Performance</h1><p>Now we have selected a chosen runtime (<code>wasmtime</code>) and interpreter (<code>quickjs</code>) we now need to test whether that combination can meet our performance requirements.</p><h2 id=some-arbitrary-code>Some Arbitrary Code</h2><p>To be somewhat realistic we need a contrived example of some code to execute in the plugin.</p><p>This example we will be using data captured by an imaginary running watch that periodically records latitude/longitude/altitude measurements as JSON objects (we have 260 <code>features</code> like below) and we want to calculate the total distance of the run but, users being users, have raised a feature request to calculate the distance of their runs in the <a href=https://en.wikipedia.org/wiki/Canadian_football_field>Canadian Football Fields</a> measure. Instead of building such an obscure request into our software we decide to use a plugin allowing us to meet this request plus any of these <a href=https://en.wikipedia.org/wiki/List_of_unusual_units_of_measurement>unusual units of measurement</a> requests without having to alter our main code base.</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;FeatureCollection&#34;</span><span class=p>,</span>
  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;track_points&#34;</span><span class=p>,</span>
  <span class=nt>&#34;crs&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;name&#34;</span><span class=p>,</span>
    <span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;urn:ogc:def:crs:OGC:1.3:CRS84&#34;</span>
    <span class=p>}</span>
  <span class=p>},</span>
  <span class=nt>&#34;features&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;Feature&#34;</span><span class=p>,</span>
      <span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;track_fid&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=nt>&#34;track_seg_id&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=nt>&#34;track_seg_point_id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
        <span class=nt>&#34;ele&#34;</span><span class=p>:</span> <span class=mi>60</span><span class=p>,</span>
        <span class=nt>&#34;time&#34;</span><span class=p>:</span> <span class=s2>&#34;2023-01-22 00:00:00+00&#34;</span>
      <span class=p>},</span>
      <span class=nt>&#34;geometry&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;Point&#34;</span><span class=p>,</span> <span class=nt>&#34;coordinates&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mf>151.22989</span><span class=p>,</span> <span class=mf>-33.89279</span><span class=p>]</span> <span class=p>}</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;Feature&#34;</span><span class=p>,</span>
      <span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;track_fid&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=nt>&#34;track_seg_id&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=nt>&#34;track_seg_point_id&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
        <span class=nt>&#34;ele&#34;</span><span class=p>:</span> <span class=mi>66</span><span class=p>,</span>
        <span class=nt>&#34;time&#34;</span><span class=p>:</span> <span class=s2>&#34;2023-01-22 00:00:56+00&#34;</span>
      <span class=p>},</span>
      <span class=nt>&#34;geometry&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;Point&#34;</span><span class=p>,</span> <span class=nt>&#34;coordinates&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mf>151.23077</span><span class=p>,</span> <span class=mf>-33.89159</span><span class=p>]</span> <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>]</span>
<span class=p>}</span></code></pre></div><p>To do the calculation we want to first implement a function to calculate the distance between two points.</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=c1>// simple approximate distance function returning distance between two points in meters
</span><span class=c1></span><span class=kd>function</span> <span class=nx>distance</span><span class=p>(</span><span class=nx>lat0</span><span class=p>,</span> <span class=nx>lon0</span><span class=p>,</span> <span class=nx>lat1</span><span class=p>,</span> <span class=nx>lon1</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=nx>lat0</span> <span class=o>==</span> <span class=nx>lat1</span> <span class=o>&amp;&amp;</span> <span class=nx>lon0</span> <span class=o>==</span> <span class=nx>lon1</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=k>const</span> <span class=nx>radlat0</span> <span class=o>=</span> <span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>PI</span> <span class=o>*</span> <span class=nx>lat0</span><span class=p>)</span> <span class=err>/ 180;</span>
    <span class=k>const</span> <span class=nx>radlat1</span> <span class=o>=</span> <span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>PI</span> <span class=o>*</span> <span class=nx>lat1</span><span class=p>)</span> <span class=err>/ 180;</span>
    <span class=k>const</span> <span class=nx>theta</span> <span class=o>=</span> <span class=nx>lon0</span> <span class=o>-</span> <span class=nx>lon1</span><span class=p>;</span>
    <span class=k>const</span> <span class=nx>radtheta</span> <span class=o>=</span> <span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>PI</span> <span class=o>*</span> <span class=nx>theta</span><span class=p>)</span> <span class=err>/ 180;</span>
    <span class=kd>let</span> <span class=nx>dist</span> <span class=o>=</span>
      <span class=nb>Math</span><span class=p>.</span><span class=nx>sin</span><span class=p>(</span><span class=nx>radlat0</span><span class=p>)</span> <span class=o>*</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>sin</span><span class=p>(</span><span class=nx>radlat1</span><span class=p>)</span> <span class=o>+</span>
      <span class=nb>Math</span><span class=p>.</span><span class=nx>cos</span><span class=p>(</span><span class=nx>radlat0</span><span class=p>)</span> <span class=o>*</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>cos</span><span class=p>(</span><span class=nx>radlat1</span><span class=p>)</span> <span class=o>*</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>cos</span><span class=p>(</span><span class=nx>radtheta</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>dist</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
      <span class=nx>dist</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=nx>dist</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>acos</span><span class=p>(</span><span class=nx>dist</span><span class=p>);</span>
    <span class=nx>dist</span> <span class=o>=</span> <span class=p>(</span><span class=nx>dist</span> <span class=o>*</span> <span class=mi>180</span><span class=p>)</span> <span class=err>/ Math.PI;</span>
    <span class=k>return</span> <span class=nx>dist</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mf>1853.159</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Then reduce the list of points to calculate the total distance.</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=c1>// calculate the total length of a set of input features in canadian football fields
</span><span class=c1></span><span class=kd>function</span> <span class=nx>calculate</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// canadian football fields are 140 meters
</span><span class=c1></span>  <span class=k>const</span> <span class=nx>candadian_football_field</span> <span class=o>=</span> <span class=mi>140</span><span class=p>;</span>

  <span class=k>return</span> <span class=nx>data</span><span class=p>.</span><span class=nx>features</span><span class=p>.</span><span class=nx>reduce</span><span class=p>(</span>
    <span class=p>(</span><span class=nx>accumulator</span><span class=p>,</span> <span class=nx>currentValue</span><span class=p>,</span> <span class=nx>currentIndex</span><span class=p>,</span> <span class=nx>array</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=nx>currentIndex</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>const</span> <span class=nx>previousValue</span> <span class=o>=</span> <span class=nx>array</span><span class=p>[</span><span class=nx>currentIndex</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span>
        <span class=k>const</span> <span class=nx>dist</span> <span class=o>=</span> <span class=nx>distance</span><span class=p>(</span>
          <span class=nx>currentValue</span><span class=p>.</span><span class=nx>geometry</span><span class=p>.</span><span class=nx>coordinates</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
          <span class=nx>currentValue</span><span class=p>.</span><span class=nx>geometry</span><span class=p>.</span><span class=nx>coordinates</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
          <span class=nx>previousValue</span><span class=p>.</span><span class=nx>geometry</span><span class=p>.</span><span class=nx>coordinates</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
          <span class=nx>previousValue</span><span class=p>.</span><span class=nx>geometry</span><span class=p>.</span><span class=nx>coordinates</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
        <span class=p>);</span>
        <span class=k>return</span> <span class=nx>accumulator</span> <span class=o>+</span> <span class=nx>dist</span> <span class=err>/ candadian_football_field;</span>
      <span class=p>}</span>
    <span class=p>},</span>
    <span class=mi>0</span>
  <span class=p>);</span>
<span class=p>}</span>
</code></pre></div><h2 id=wasm-interfacing>WASM Interfacing</h2><p>It is still somewhat difficult to get data in and out of a <code>WASM</code> virtual machine as it does not directly expose use of all of the <a href=https://webassembly.github.io/spec/core/syntax/types.html>types</a> you may be used to. Thanks to an excellent blog post by <a href=https://petermalmgren.com/serverside-wasm-data/>Peter Malmgren</a> who explores different options for passing data into a WASM instance I have implemented his &lsquo;Approach 2: Using exported functions and memory&rsquo; pattern. The benefit of this approach is that it allows the the virtual machine <code>stdout</code> and <code>stderr</code> to be disabled and it is easy to add additional host functions to expose to the WASM instance.</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=n>linker</span><span class=p>.</span><span class=n>func_wrap</span><span class=p>(</span><span class=w>
</span><span class=w>    </span><span class=s>&#34;host&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=s>&#34;get_input_size&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>move</span><span class=w> </span><span class=o>|</span><span class=n>_</span>: <span class=nc>Caller</span><span class=o>&lt;</span><span class=na>&#39;_</span><span class=p>,</span><span class=w> </span><span class=n>WasiCtx</span><span class=o>&gt;|</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>i32</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>input_size</span><span class=p>)</span><span class=w> </span><span class=p>},</span><span class=w>
</span><span class=w></span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span><span class=w></span></code></pre></div><p>You can see the code for the two halves of the interface code here:</p><ul><li><a href=https://github.com/seddonm1/quickjs/blob/e9d8afd6e8f74d41e674a30821a344d3423b8260/crates/quickjs-wasm/src/io.rs>WASM</a> interface code.</li><li>Host <a href=https://github.com/seddonm1/quickjs/blob/e9d8afd6e8f74d41e674a30821a344d3423b8260/crates/quickjs/src/lib.rs#L65>wasmtime</a> interface code.</li></ul><h2 id=baseline>Baseline</h2><p>The initial naive implementation is to instantiate a new QuickJS <code>Context</code>, retrieve the input string from the host, execute it and return the output. This is executing in <code>8.2ms</code> per iteration which is definitely not quick. The benchmarks below were run using <a href=https://github.com/seddonm1/quickjs/blob/e9d8afd6e8f74d41e674a30821a344d3423b8260/crates/quickjs/benches/benchmark.rs>this code</a>.</p><p>At this stage it is sensible to ask why we are instantiating a new runtime each execution? Firstly as there is a chance to <a href=https://github.com/bytecodealliance/wasmtime/issues/2751>leak memory</a> and secondly then our isolation guarantees (between executions) become weaker.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>try_execute             time:   <span class=o>[</span><span class=m>8</span>.3125 ms <span class=m>8</span>.3329 ms <span class=m>8</span>.3544 ms<span class=o>]</span>
Found <span class=m>5</span> outliers among <span class=m>100</span> measurements <span class=o>(</span><span class=m>5</span>.00%<span class=o>)</span>
  <span class=m>1</span> <span class=o>(</span><span class=m>1</span>.00%<span class=o>)</span> low mild
  <span class=m>3</span> <span class=o>(</span><span class=m>3</span>.00%<span class=o>)</span> high mild
  <span class=m>1</span> <span class=o>(</span><span class=m>1</span>.00%<span class=o>)</span> high severe</code></pre></div><p>Code:</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>mod</span> <span class=nn>io</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>anyhow</span>::<span class=nb>Result</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>quickjs_wasm_rs</span>::<span class=n>Context</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>static</span><span class=w> </span><span class=n>SCRIPT_NAME</span>: <span class=kp>&amp;</span><span class=kt>str</span> <span class=o>=</span><span class=w> </span><span class=s>&#34;script.js&#34;</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Context</span>::<span class=n>default</span><span class=p>();</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>io</span>::<span class=n>get_input_string</span><span class=p>()</span><span class=o>?</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=nb>Some</span><span class=p>(</span><span class=n>input</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=n>eval_global</span><span class=p>(</span><span class=n>SCRIPT_NAME</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>input</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span><span class=w>            </span><span class=n>io</span>::<span class=n>set_output_value</span><span class=p>(</span><span class=nb>Some</span><span class=p>(</span><span class=n>output</span><span class=p>))</span><span class=w>
</span><span class=w>        </span><span class=p>}</span><span class=w>
</span><span class=w>        </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>io</span>::<span class=n>set_output_value</span><span class=p>(</span><span class=nb>None</span><span class=p>),</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w></span></code></pre></div><h2 id=wizer>Wizer</h2><p>In this 2021 post <a href=https://bytecodealliance.org/articles/making-javascript-run-fast-on-webassembly>Making JavaScript run fast on WebAssembly</a> Mozilla introduced the idea of taking snapshots of a WASM virtual machine state allowing work to be performed at WASM &lsquo;compile&rsquo; time rather than at run time. In this case we know we need a QuickJS <code>Context</code> each execution so if we were able to instantiate this once rather than in each execution then there should be some performance improvenment. A tool called <a href=https://github.com/bytecodealliance/wizer>Wizer</a> has been built to achieve this.</p><p>In this case there <em>may be</em> a very slighty improvement of around 2% (100-200µs) per iteration which is not much but may add up if this function is executed millions of times per day and for such little effort there is no real reason not to do it.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>try_execute             time:   <span class=o>[</span><span class=m>8</span>.0596 ms <span class=m>8</span>.0959 ms <span class=m>8</span>.1350 ms<span class=o>]</span>
                        change: <span class=o>[</span>-3.3404% -2.8433% -2.3509%<span class=o>]</span> <span class=o>(</span><span class=nv>p</span> <span class=o>=</span> <span class=m>0</span>.00 &lt; <span class=m>0</span>.05<span class=o>)</span>
                        Performance has improved.
Found <span class=m>2</span> outliers among <span class=m>100</span> measurements <span class=o>(</span><span class=m>2</span>.00%<span class=o>)</span>
  <span class=m>2</span> <span class=o>(</span><span class=m>2</span>.00%<span class=o>)</span> high mild</code></pre></div><p>Code:</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>static</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>JS_CONTEXT</span>: <span class=nc>OnceCell</span><span class=o>&lt;</span><span class=n>Context</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OnceCell</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=cp>#[export_name = </span><span class=s>&#34;wizer.initialize&#34;</span><span class=cp>]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Context</span>::<span class=n>default</span><span class=p>();</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=n>JS_CONTEXT</span><span class=p>.</span><span class=n>set</span><span class=p>(</span><span class=n>context</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>JS_CONTEXT</span><span class=p>.</span><span class=n>get</span><span class=p>().</span><span class=n>unwrap</span><span class=p>()</span><span class=w> </span><span class=p>};</span><span class=w>
</span><span class=w></span></code></pre></div><h2 id=wizer-1>Wizer+</h2><p>Given that the QuickJS <code>Context</code> does not improve the <code>8.1ms</code> execution time, what would happen if we could move more logic into the <code>wizer.initialize</code> code like registering the <code>distance</code> and <code>calculate</code> functions as it must take at least some time for QuickJS to parse the string representation into internal binary code?</p><p>The benchmarks suggest this is not much of a problem but does come with a major downside: a custom <code>WASM</code> module will have to be built and deployed for each combination of required functions. Unfortunately, at time of writing, Wizer is unable to support both <code>.make_linker(...)</code> and <code>allow_wasi</code> which would allow a one time injection and snapshot of these functions at runtime.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>try_execute             time:   <span class=o>[</span><span class=m>7</span>.9269 ms <span class=m>7</span>.9709 ms <span class=m>8</span>.0195 ms<span class=o>]</span>
                        change: <span class=o>[</span>-2.2372% -1.5439% -0.8280%<span class=o>]</span> <span class=o>(</span><span class=nv>p</span> <span class=o>=</span> <span class=m>0</span>.00 &lt; <span class=m>0</span>.05<span class=o>)</span>
                        Change within noise threshold.
Found <span class=m>4</span> outliers among <span class=m>100</span> measurements <span class=o>(</span><span class=m>4</span>.00%<span class=o>)</span>
  <span class=m>2</span> <span class=o>(</span><span class=m>2</span>.00%<span class=o>)</span> high mild
  <span class=m>2</span> <span class=o>(</span><span class=m>2</span>.00%<span class=o>)</span> high severe</code></pre></div><h2 id=calculation-or-parsing>Calculation or Parsing?</h2><p>At this stage we have eliminated the QuickJS <code>Context</code> and <code>wizer.initialize</code>ing the <code>distance</code> and <code>calculate</code> functions as the source of slowness leaving two remaining candidates as the source of the poor performance; getting the <code>data</code> object into QuickJS and the actual calculation time. The easiest way to test this is to also move the <code>data</code> element into the <code>wizer.initialize</code> function so that the script execution is running against already instantiated data.</p><p>This benchmark clearly shows that the actual calculation is only around 11% of the execution time so the biggest gain will be from working out how to more efficiently pass in <code>data</code>.</p><div class=highlight><pre class=chroma><code class=language-time data-lang=time>try_execute             time:   [890.44 µs 898.09 µs 906.87 µs]
                        change: [-88.793% -88.647% -88.501%] (p = 0.00 &lt; 0.05)
                        Performance has improved.
Found 6 outliers among 100 measurements (6.00%)
  4 (4.00%) high mild
  2 (2.00%) high severe</code></pre></div><p>Code:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=nx>calculate</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</code></pre></div><h2 id=javy-to-the-rescue>Javy to the rescue</h2><p>At this stage we can re-examine at the <code>Javy</code> code and see that a lot of the work they have done appears to have followed this same process. The <code>quickjs-wasm-rs</code> package has the <code>json</code> or <code>msgpack</code> feature flags which enable different serialization options for getting data in and out of the QuickJS <code>Context</code>. These functions construct the QuickJS <code>Value</code> objects directly from an input <code>json</code> string (or serialized <code>msgpack</code> bytes) rather than relying on the QuickJS parser to parse the 100KB+ input string.</p><p>The benchmarks show a large reduction from the original <code>8.1ms</code> to just <code>2.5ms</code> per execution with the <code>json</code> approach with a minor downside that the input data is set to a fixed global variable <code>data</code> (but this could also be set via another call to the host if desired). The code also uses a completely generic <code>WASM</code> module that is not custom compiled for each deployment allowing it to execute any arbitrary code.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>try_execute             time:   <span class=o>[</span><span class=m>2</span>.5336 ms <span class=m>2</span>.5513 ms <span class=m>2</span>.5724 ms<span class=o>]</span>
                        change: <span class=o>[</span>-68.282% -67.992% -67.677%<span class=o>]</span> <span class=o>(</span><span class=nv>p</span> <span class=o>=</span> <span class=m>0</span>.00 &lt; <span class=m>0</span>.05<span class=o>)</span>
                        Performance has improved.
Found <span class=m>6</span> outliers among <span class=m>100</span> measurements <span class=o>(</span><span class=m>6</span>.00%<span class=o>)</span>
  <span class=m>4</span> <span class=o>(</span><span class=m>4</span>.00%<span class=o>)</span> high mild
  <span class=m>2</span> <span class=o>(</span><span class=m>2</span>.00%<span class=o>)</span> high severe</code></pre></div><h2 id=parallel>Parallel</h2><p>Finally we will explore parallelization with the excellent <a href=https://github.com/rayon-rs/rayon>rayon</a> libary. As each execution is running in a single thread and each execution is a pure function we can easily run them in parallel - which may or may not make sense for your use case. Some care needs to be taken here as instantiating a Rayon task per execution does incur quite a lot of scheduling cost so <code>chunk</code>ing into partitions and executing in parallel gives best results.</p><p>Here 1000 iterations are executed in parallel on a 16 core laptop:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>cargo run --release --example par_iter

elapsed: <span class=m>475</span>.869146ms
iteration: <span class=m>475</span>.869µs</code></pre></div><p>The sequential example is also available via:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>cargo run --release --example iter</code></pre></div><h1 id=conclusion>Conclusion</h1><p>In this series of steps I have demonstrated a plugin system for Rust that meets my goals of arbitrary code execution in a sandboxed environment at a <em>reasonable</em> <code>2.5ms</code> execution speed.</p><p>The code for this post is available at <a href=https://github.com/seddonm1/quickjs>https://github.com/seddonm1/quickjs</a>.</p></div><div id=source>If you find an error please raise a <a class="basic-alignment left" href=https://github.com/seddonm1/seddonm1.github.io/blob/main/content/posts/plugins-for-rust.md>pull request</a>.</div><div id=links><a class="basic-alignment left" href=https://reorchestrate.com/posts/debezium-performance-impact/>&laquo; Debezium does not impact source database performance</a></div></section></body></html>