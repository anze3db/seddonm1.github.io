<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><link href="https://fonts.googleapis.com/css?family=Open+Sans:400|Old+Standard+TT:400" rel=stylesheet type=text/css><link rel=icon type=image/png href=https://reorchestrate.com/favicon_16x16.png sizes=16x16><link rel=icon type=image/png href=https://reorchestrate.com/favicon_32x32.png sizes=32x32><link rel=icon type=image/png href=https://reorchestrate.com/favicon_128x128.png sizes=128x128><title>Custom JWT Claims with Ory Kratos</title><link rel=canonical href=https://reorchestrate.com/posts/custom-jwt-claims-with-ory-kratos/><style>*{border:0;font:inherit;font-size:100%;vertical-align:baseline;margin:0;padding:0;color:#000;text-decoration-skip:ink}body{font-family:open sans,myriad pro,Myriad,sans-serif;font-size:17px;-webkit-font-smoothing:antialiased;line-height:160%;color:#1d1313;max-width:950px;margin:auto}p{margin:20px 0}a img{border:none}img{margin:10px auto;max-width:100%;display:block}.left-justify{float:left}.right-justify{float:right}pre,code{font:12px Consolas,liberation mono,Menlo,Courier,monospace;background-color:#f7f7f7}code{font-size:12px;padding:4px}pre{margin-top:0;margin-bottom:16px;word-wrap:normal;padding:16px;overflow:auto;font-size:85%;line-height:1.45}pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:#0000;border:0}pre code::before,pre code::after{content:normal}em,q,em,dfn{font-style:italic}.sans,html .gist .gist-file .gist-meta{font-family:open sans,myriad pro,Myriad,sans-serif}.mono,pre,code,tt,p code,li code{font-family:Menlo,Monaco,andale mono,lucida console,courier new,monospace}.heading,.serif,h1,h2,h3,h4,h5{font-family:old standard tt,serif}strong{font-weight:600}table{width:100%}thead{font-weight:800;background:#dadada}tbody tr:nth-child(even){background:#f7f7f7}table td,th{padding:2px}q:before{content:"\201C"}q:after{content:"\201D"}del,s{text-decoration:line-through}blockquote{font-family:old standard tt,serif;text-align:center;padding:50px}blockquote p{display:inline-block;font-style:italic}blockquote:before,blockquote:after{font-family:old standard tt,serif;content:'\201C';font-size:35px;color:#403c3b}blockquote:after{content:'\201D'}hr{width:40%;height:1px;background:#403c3b;margin:25px auto}h1{font-weight:700;font-size:35px}h2{font-weight:700;font-size:28px}h3{font-weight:700;font-size:22px;margin-top:28px}h4{font-weight:700;font-size:20px;margin-top:20px}h5{font-size:18px;margin-top:18px}h1 a,h2 a,h3 a,h4 a,h5 a{text-decoration:none}h1,h2{margin-top:28px}#sub-header,time{color:#403c3b;font-size:13px}#sub-header{margin:0 4px}#nav h1 a{font-size:35px;color:#1d1313;line-height:120%}.posts_listing a,#nav a{text-decoration:none}li{margin-left:20px}ul li{margin-left:5px}ul li{list-style-type:none}ul li:before{content:"\00BB \0020"}#nav ul li:before,.posts_listing li:before{content:'';margin-right:0}#content{text-align:left;width:100%;font-size:15px;padding:60px 0 80px}#content h1,#content h2{margin-bottom:5px}#content h2{font-size:25px}#content .entry-content{margin-top:15px}#content time{margin-left:3px}#content h1{font-size:30px}.highlight{margin:10px 0}.posts_listing{margin:0 0 50px}.posts_listing li{margin:0 0 25px 15px}.posts_listing li a:hover,#nav a:hover{text-decoration:underline}#nav{text-align:center;position:static;margin-top:60px}#nav ul{display:table;margin:8px auto 0}#nav li{list-style-type:none;display:table-cell;font-size:15px;padding:0 20px}#source{margin:50px 0 0}#links{margin:50px 0 0}#links :nth-child(2){float:right}#not-found{text-align:center}#not-found a{font-family:old standard tt,serif;font-size:200px;text-decoration:none;display:inline-block;padding-top:225px}#nav .sub{font-size:80%;display:inline-block;vertical-align:middle}#nav .sub p{color:#403c3b;margin:0}#nav .sub a{text-decoration:none}#nav .sub svg{fill:#403c3b;display:inline-block;vertical-align:middle;padding-bottom:3px;padding-right:5px}@media(max-width:750px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:28px}#nav li{font-size:13px;padding:0 15px}#content{margin-top:0;padding-top:50px;font-size:14px}#content h1{font-size:25px}#content h2{font-size:22px}.posts_listing li div{font-size:12px}}@media(max-width:400px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:22px}#nav li{font-size:12px;padding:0 10px}#content{margin-top:0;padding-top:20px;font-size:12px}#content h1{font-size:20px}#content h2{font-size:18px}.posts_listing li div{font-size:12px}}.chroma{background-color:#f0f0f0}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em}.chroma .ln{margin-right:.4em;padding:0 .4em}.chroma .k{color:#007020;font-weight:700}.chroma .kc{color:#007020;font-weight:700}.chroma .kd{color:#007020;font-weight:700}.chroma .kn{color:#007020;font-weight:700}.chroma .kp{color:#007020}.chroma .kr{color:#007020;font-weight:700}.chroma .kt{color:#902000}.chroma .na{color:#4070a0}.chroma .nb{color:#007020}.chroma .nc{color:#0e84b5;font-weight:700}.chroma .no{color:#60add5}.chroma .nd{color:#555;font-weight:700}.chroma .ni{color:#d55537;font-weight:700}.chroma .ne{color:#007020}.chroma .nf{color:#06287e}.chroma .nl{color:#002070;font-weight:700}.chroma .nn{color:#0e84b5;font-weight:700}.chroma .nt{color:#062873;font-weight:700}.chroma .nv{color:#bb60d5}.chroma .s{color:#4070a0}.chroma .sa{color:#4070a0}.chroma .sb{color:#4070a0}.chroma .sc{color:#4070a0}.chroma .dl{color:#4070a0}.chroma .sd{color:#4070a0;font-style:italic}.chroma .s2{color:#4070a0}.chroma .se{color:#4070a0;font-weight:700}.chroma .sh{color:#4070a0}.chroma .si{color:#70a0d0;font-style:italic}.chroma .sx{color:#c65d09}.chroma .sr{color:#235388}.chroma .s1{color:#4070a0}.chroma .ss{color:#517918}.chroma .m{color:#40a070}.chroma .mb{color:#40a070}.chroma .mf{color:#40a070}.chroma .mh{color:#40a070}.chroma .mi{color:#40a070}.chroma .il{color:#40a070}.chroma .mo{color:#40a070}.chroma .o{color:#666}.chroma .ow{color:#007020;font-weight:700}.chroma .c{color:#60a0b0;font-style:italic}.chroma .ch{color:#60a0b0;font-style:italic}.chroma .cm{color:#60a0b0;font-style:italic}.chroma .c1{color:#60a0b0;font-style:italic}.chroma .cs{color:#60a0b0;background-color:#fff0f0}.chroma .cp{color:#007020}.chroma .cpf{color:#007020}.chroma .gd{color:#a00000}.chroma .ge{font-style:italic}.chroma .gr{color:red}.chroma .gh{color:navy;font-weight:700}.chroma .gi{color:#00a000}.chroma .go{color:#888}.chroma .gp{color:#c65d09;font-weight:700}.chroma .gs{font-weight:700}.chroma .gu{color:purple;font-weight:700}.chroma .gt{color:#04d}.chroma .w{color:#bbb}</style></head><body><section id=nav><h1><a href=https://reorchestrate.com/>reorchestrate</a></h1><section class=section><div class=sub><p>&copy; Mike Seddon 2024 |
<a href=https://www.github.com/seddonm1 target=_blank><svg width="22" height="22" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M896 128q209 0 385.5 103T1561 510.5 1664 896q0 251-146.5 451.5T1139 1625q-27 5-40-7t-13-30q0-3 .5-76.5t.5-134.5q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105T1386 856q0-119-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27T578 459.5 493 446q-45 113-8 204-79 87-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-39 36-49 103-21 10-45 15t-57 5-65.5-21.5T484 1274q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 88.5t.5 54.5q0 18-13 30t-40 7q-232-77-378.5-277.5T128 896q0-209 103-385.5T510.5 231 896 128zM419 1231q3-7-7-12-10-3-13 2-3 7 7 12 9 6 13-2zm31 34q7-5-2-16-10-9-16-3-7 5 2 16 10 10 16 3zm30 45q9-7 0-19-8-13-17-6-9 5 0 18t17 7zm42 42q8-8-4-19-12-12-20-3-9 8 4 19 12 12 20 3zm57 25q3-11-13-16-15-4-19 7t13 15q15 6 19-6zm63 5q0-13-17-11-16 0-16 11 0 13 17 11 16 0 16-11zm58-10q-2-11-18-9-16 3-14 15t18 8 14-14z"/></svg></a><a href=https://www.linkedin.com/in/mikeseddonau/ target=_blank><svg width="22" height="22" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M365 1414h231V720H365v694zm246-908q-1-52-36-86t-93-34-94.5 34-36.5 86q0 51 35.5 85.5T479 626h1q59 0 95-34.5t36-85.5zm585 908h231v-398q0-154-73-233t-193-79q-136 0-209 117h2V720H723q3 66 0 694h231v-388q0-38 7-56 15-35 45-59.5t74-24.5q116 0 116 157v371zm468-998v960q0 119-84.5 203.5T1376 1664H416q-119 0-203.5-84.5T128 1376V416q0-119 84.5-203.5T416 128h960q119 0 203.5 84.5T1664 416z"/></svg></a></p></div></section><ul></ul></section><section id=content><h1>Custom JWT Claims with Ory Kratos</h1><div id=sub-header>2 July 2024</div><div class=entry-content><p><a href=https://en.wikipedia.org/wiki/JSON_Web_Token>JSON Web Tokens</a> (<code>JWT</code>) are data structures that allow the holder of the token to assert <code>claims</code> that are able to be cryptographically verified. An example would be that a claim could hold a user <code>claim</code> <code>role</code> like <code>administrator</code> that if proven to be unaltered (using a shared public key) then could be used to provide access to certain <code>administrator</code> functions.</p><p>Tools like <a href=https://postgrest.org/en/v12/>PostgREST</a>, <a href=https://hasura.io/>Hasura</a> and <a href=https://supabase.com/>Supabase</a> (a managed PostgREST) rely on <code>JWT</code>s to carry a user&rsquo;s <code>claims</code> where the <code>role</code> claim is used to <a href=https://www.postgresql.org/docs/current/sql-set-role.html>set a Postgres role</a> to enforce role-based access control. Tools like <a href=https://auth0.com/>Auth0</a> and <a href=https://github.com/supabase/auth>Supabase Auth</a> are tools that are commonly used to generate the <code>JWT</code> and can be configured to create tokens that contain the correct <code>claims</code> format for the target system.</p><h1 id=ory-kratos>Ory Kratos</h1><p><a href=https://www.ory.sh/kratos/>Ory Kratos</a> is part of a suite of products that provide authentication, identity management and permissions with <code>Kratos</code> focused on the login/authentication side. <code>Kratos</code> supports modern login solutions like <a href=https://www.ory.sh/docs/kratos/passwordless/passkeys>Passkey</a> alongside the traditional methods, can be self-hosted, is <a href=https://github.com/ory/kratos>open-source</a>, supports many <a href=https://www.ory.sh/docs/self-hosted/deployment#sql-persistent>databases</a> and can be easily packaged as a <a href=https://hub.docker.com/r/oryd/kratos>Docker container</a>. These benefits mean it is possible to easily start with a <a href=https://litestream.io/>SQLite/Litestream</a> instance, for example, and migrate to an Ory managed instance if required.</p><p>By default, upon <code>login</code>, a user will be issued an Ory <code>Session</code> object that can be verified by the server (by calling <code>/session/whoami</code>) against the <code>Kratos</code> instance to validate the user and apply authentication and authorization. To convert this <code>Session</code> object into a <code>JWT</code> with the correct claims <code>Kratos</code> provides a not-so-well documented feature:</p><h1 id=converting-a-session-to-jwt>Converting a Session to JWT</h1><p><code>Kratos</code> is configured using a <code>kratos.yml</code> file that contains the configuration for converting the <code>Session</code> to <code>JWT</code>. Hidden away in this <a href=https://github.com/ory/kratos/pull/3472>pull request</a> is how to configure it. The idea is that <code>/session/whoami</code> can be called with an optional <code>tokenize_as</code> parameter thats allows the caller to specify a target token format.</p><p>In the below example <code>tokenize_as</code> could be set to either <code>postgrest</code> or <code>hasura</code>. The three values that must be provided are <code>ttl</code>, which controls the <code>exp</code>iry of the token and <code>jwks_url</code> and <code>claims_mapper_url</code> which are described below. Due to the difficulty revoking <code>JWT</code>s it is a good idea to keep the <code>ttl</code> as low as practical.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml>session<span class=p>:</span><span class=w>
</span><span class=w>  </span>whoami<span class=p>:</span><span class=w>
</span><span class=w>    </span>tokenizer<span class=p>:</span><span class=w>
</span><span class=w>      </span>templates<span class=p>:</span><span class=w>
</span><span class=w>        </span>postgrest<span class=p>:</span><span class=w>
</span><span class=w>          </span>ttl<span class=p>:</span><span class=w> </span>1h<span class=w>
</span><span class=w>          </span>jwks_url<span class=p>:</span><span class=w> </span>file<span class=p>:</span>///etc/config/kratos/jwk.eddsa.json<span class=w>
</span><span class=w>          </span>claims_mapper_url<span class=p>:</span><span class=w> </span>file<span class=p>:</span>///etc/config/kratos/postgrest.claims.jsonnet<span class=w>
</span><span class=w>        </span>hasura<span class=p>:</span><span class=w>
</span><span class=w>          </span>ttl<span class=p>:</span><span class=w> </span>1h<span class=w>
</span><span class=w>          </span>jwks_url<span class=p>:</span><span class=w> </span>file<span class=p>:</span>///etc/config/kratos/jwk.eddsa.json<span class=w>
</span><span class=w>          </span>claims_mapper_url<span class=p>:</span><span class=w> </span>file<span class=p>:</span>///etc/config/kratos/hasura.claims.jsonnet</code></pre></div><h1 id=jwks-url>jwks_url</h1><p>To sign the token <code>Kratos</code> must be provided a <code>key</code> as a JSON Web Key. There are many ways to create such a key but an easy one is to download another Ory product, <a href=https://www.ory.sh/oathkeeper/>Oathkeeper</a> (binaries are <a href=https://github.com/ory/oathkeeper/releases>available on github</a>) and run the command:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>oathkeeper credentials generate --alg EdDSA</code></pre></div><p>A value like below will be returned which can be saved as <code>/etc/config/kratos/jwk.eddsa.json</code> and accessed via the <code>Kratos</code> instance.</p><p>The <code>JWK</code> can easily to passed into <a href=https://postgrest.org/en/v12/references/configuration.html#jwt-secret>PostgREST</a> via environment variable <code>PGRST_JWT_SECRET</code> or <a href=https://hasura.io/docs/latest/auth/authentication/jwt/#configure-hasura-jwt-mode>Hasura</a> via <code>HASURA_GRAPHQL_JWT_SECRET</code> to allow them to verify the <code>JWT</code>.</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;keys&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>&#34;use&#34;</span><span class=p>:</span> <span class=s2>&#34;sig&#34;</span><span class=p>,</span>
      <span class=nt>&#34;kty&#34;</span><span class=p>:</span> <span class=s2>&#34;OKP&#34;</span><span class=p>,</span>
      <span class=nt>&#34;kid&#34;</span><span class=p>:</span> <span class=s2>&#34;10dd524d-decb-48ff-b84d-7d389c10f2f7&#34;</span><span class=p>,</span>
      <span class=nt>&#34;crv&#34;</span><span class=p>:</span> <span class=s2>&#34;Ed25519&#34;</span><span class=p>,</span>
      <span class=nt>&#34;alg&#34;</span><span class=p>:</span> <span class=s2>&#34;EdDSA&#34;</span><span class=p>,</span>
      <span class=nt>&#34;x&#34;</span><span class=p>:</span> <span class=s2>&#34;58zYrqRbmsXkyg2t50S9_RoZQb2cVXnSfxUU4aPhDAk&#34;</span><span class=p>,</span>
      <span class=nt>&#34;d&#34;</span><span class=p>:</span> <span class=s2>&#34;1F_Thkzgc43ZiI_qqnf1xuNHqN6EPJYgpX5NXm15bb0&#34;</span>
    <span class=p>}</span>
  <span class=p>]</span>
<span class=p>}</span></code></pre></div><h1 id=claims-mapper-url>claims_mapper_url</h1><p>The claims mapper is where a custom configuration can be defined using the <a href=https://jsonnet.org/>Jsonnet</a> configuration language. The claims for a Hasura endpoint can be configured like:</p><div class=highlight><pre class=chroma><code class=language-jsonnet data-lang=jsonnet>local session = std.extVar(&#39;session&#39;);

{
  &#34;claims&#34;: {
    &#34;https://hasura.io/jwt/claims&#34;: {
      &#34;x-hasura-default-role&#34;: &#34;user&#34;,
      &#34;x-hasura-allowed-roles&#34;: [&#34;user&#34;],
      &#34;x-hasura-user-id&#34;: session.identity.id,
    }
  }
}</code></pre></div><p>The much simplier configuration for PostgREST may look like:</p><div class=highlight><pre class=chroma><code class=language-jsonnet data-lang=jsonnet>local session = std.extVar(&#39;session&#39;);

{
  &#34;claims&#34;: {
    &#34;role&#34;: &#34;user&#34;,
    &#34;userId&#34;: session.identity.id
  }
}</code></pre></div></div><div id=source>If you find an error please raise a <a class="basic-alignment left" href=https://github.com/seddonm1/seddonm1.github.io/blob/main/content/posts/custom-jwt-claims-with-ory-kratos.md>pull request</a>.</div><div id=links><a class="basic-alignment left" href=https://reorchestrate.com/posts/plugins-for-rust/>&laquo; Plugins for Rust</a></div></section></body></html>