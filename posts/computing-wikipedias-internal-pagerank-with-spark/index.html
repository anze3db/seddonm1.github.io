<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><link href="https://fonts.googleapis.com/css?family=Open+Sans:400|Old+Standard+TT:400" rel=stylesheet type=text/css><link rel=icon type=image/png href=https://reorchestrate.com/favicon_16x16.png sizes=16x16><link rel=icon type=image/png href=https://reorchestrate.com/favicon_32x32.png sizes=32x32><link rel=icon type=image/png href=https://reorchestrate.com/favicon_128x128.png sizes=128x128><title>Computing WikiPedia&#39;s internal PageRank with Apache Spark</title><link rel=canonical href=https://reorchestrate.com/posts/computing-wikipedias-internal-pagerank-with-spark/><style>*{border:0;font:inherit;font-size:100%;vertical-align:baseline;margin:0;padding:0;color:#000;text-decoration-skip:ink}body{font-family:open sans,myriad pro,Myriad,sans-serif;font-size:17px;-webkit-font-smoothing:antialiased;line-height:160%;color:#1d1313;max-width:950px;margin:auto}p{margin:20px 0}a img{border:none}img{margin:10px auto;max-width:100%;display:block}.left-justify{float:left}.right-justify{float:right}pre,code{font:12px Consolas,liberation mono,Menlo,Courier,monospace;background-color:#f7f7f7}code{font-size:12px;padding:4px}pre{margin-top:0;margin-bottom:16px;word-wrap:normal;padding:16px;overflow:auto;font-size:85%;line-height:1.45}pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:#0000;border:0}pre code::before,pre code::after{content:normal}em,q,em,dfn{font-style:italic}.sans,html .gist .gist-file .gist-meta{font-family:open sans,myriad pro,Myriad,sans-serif}.mono,pre,code,tt,p code,li code{font-family:Menlo,Monaco,andale mono,lucida console,courier new,monospace}.heading,.serif,h1,h2,h3,h4,h5{font-family:old standard tt,serif}strong{font-weight:600}table{width:100%}thead{font-weight:800;background:#dadada}tbody tr:nth-child(even){background:#f7f7f7}table td,th{padding:2px}q:before{content:"\201C"}q:after{content:"\201D"}del,s{text-decoration:line-through}blockquote{font-family:old standard tt,serif;text-align:center;padding:50px}blockquote p{display:inline-block;font-style:italic}blockquote:before,blockquote:after{font-family:old standard tt,serif;content:'\201C';font-size:35px;color:#403c3b}blockquote:after{content:'\201D'}hr{width:40%;height:1px;background:#403c3b;margin:25px auto}h1{font-weight:700;font-size:35px}h2{font-weight:700;font-size:28px}h3{font-weight:700;font-size:22px;margin-top:28px}h4{font-weight:700;font-size:20px;margin-top:20px}h5{font-size:18px;margin-top:18px}h1 a,h2 a,h3 a,h4 a,h5 a{text-decoration:none}h1,h2{margin-top:28px}#sub-header,time{color:#403c3b;font-size:13px}#sub-header{margin:0 4px}#nav h1 a{font-size:35px;color:#1d1313;line-height:120%}.posts_listing a,#nav a{text-decoration:none}li{margin-left:20px}ul li{margin-left:5px}ul li{list-style-type:none}ul li:before{content:"\00BB \0020"}#nav ul li:before,.posts_listing li:before{content:'';margin-right:0}#content{text-align:left;width:100%;font-size:15px;padding:60px 0 80px}#content h1,#content h2{margin-bottom:5px}#content h2{font-size:25px}#content .entry-content{margin-top:15px}#content time{margin-left:3px}#content h1{font-size:30px}.highlight{margin:10px 0}.posts_listing{margin:0 0 50px}.posts_listing li{margin:0 0 25px 15px}.posts_listing li a:hover,#nav a:hover{text-decoration:underline}#nav{text-align:center;position:static;margin-top:60px}#nav ul{display:table;margin:8px auto 0}#nav li{list-style-type:none;display:table-cell;font-size:15px;padding:0 20px}#links{margin:50px 0 0}#links :nth-child(2){float:right}#not-found{text-align:center}#not-found a{font-family:old standard tt,serif;font-size:200px;text-decoration:none;display:inline-block;padding-top:225px}#nav .sub{font-size:80%;display:inline-block;vertical-align:middle}#nav .sub p{color:#403c3b;margin:0}#nav .sub a{text-decoration:none}#nav .sub svg{fill:#403c3b;display:inline-block;vertical-align:middle;padding-bottom:3px;padding-right:5px}@media(max-width:750px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:28px}#nav li{font-size:13px;padding:0 15px}#content{margin-top:0;padding-top:50px;font-size:14px}#content h1{font-size:25px}#content h2{font-size:22px}.posts_listing li div{font-size:12px}}@media(max-width:400px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:22px}#nav li{font-size:12px;padding:0 10px}#content{margin-top:0;padding-top:20px;font-size:12px}#content h1{font-size:20px}#content h2{font-size:18px}.posts_listing li div{font-size:12px}}.chroma{background-color:#f0f0f0}.chroma .err{}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em}.chroma .ln{margin-right:.4em;padding:0 .4em}.chroma .k{color:#007020;font-weight:700}.chroma .kc{color:#007020;font-weight:700}.chroma .kd{color:#007020;font-weight:700}.chroma .kn{color:#007020;font-weight:700}.chroma .kp{color:#007020}.chroma .kr{color:#007020;font-weight:700}.chroma .kt{color:#902000}.chroma .na{color:#4070a0}.chroma .nb{color:#007020}.chroma .nc{color:#0e84b5;font-weight:700}.chroma .no{color:#60add5}.chroma .nd{color:#555;font-weight:700}.chroma .ni{color:#d55537;font-weight:700}.chroma .ne{color:#007020}.chroma .nf{color:#06287e}.chroma .nl{color:#002070;font-weight:700}.chroma .nn{color:#0e84b5;font-weight:700}.chroma .nt{color:#062873;font-weight:700}.chroma .nv{color:#bb60d5}.chroma .s{color:#4070a0}.chroma .sa{color:#4070a0}.chroma .sb{color:#4070a0}.chroma .sc{color:#4070a0}.chroma .dl{color:#4070a0}.chroma .sd{color:#4070a0;font-style:italic}.chroma .s2{color:#4070a0}.chroma .se{color:#4070a0;font-weight:700}.chroma .sh{color:#4070a0}.chroma .si{color:#70a0d0;font-style:italic}.chroma .sx{color:#c65d09}.chroma .sr{color:#235388}.chroma .s1{color:#4070a0}.chroma .ss{color:#517918}.chroma .m{color:#40a070}.chroma .mb{color:#40a070}.chroma .mf{color:#40a070}.chroma .mh{color:#40a070}.chroma .mi{color:#40a070}.chroma .il{color:#40a070}.chroma .mo{color:#40a070}.chroma .o{color:#666}.chroma .ow{color:#007020;font-weight:700}.chroma .c{color:#60a0b0;font-style:italic}.chroma .ch{color:#60a0b0;font-style:italic}.chroma .cm{color:#60a0b0;font-style:italic}.chroma .c1{color:#60a0b0;font-style:italic}.chroma .cs{color:#60a0b0;background-color:#fff0f0}.chroma .cp{color:#007020}.chroma .cpf{color:#007020}.chroma .gd{color:#a00000}.chroma .ge{font-style:italic}.chroma .gr{color:red}.chroma .gh{color:navy;font-weight:700}.chroma .gi{color:#00a000}.chroma .go{color:#888}.chroma .gp{color:#c65d09;font-weight:700}.chroma .gs{font-weight:700}.chroma .gu{color:purple;font-weight:700}.chroma .gt{color:#04d}.chroma .w{color:#bbb}</style></head><body><section id=nav><h1><a href=https://reorchestrate.com/>reorchestrate</a></h1><section class=section><div class=sub><p>&copy; Mike Seddon 2023 |
<a href=https://www.github.com/seddonm1 target=_blank><svg width="22" height="22" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M896 128q209 0 385.5 103T1561 510.5 1664 896q0 251-146.5 451.5T1139 1625q-27 5-40-7t-13-30q0-3 .5-76.5t.5-134.5q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105T1386 856q0-119-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27T578 459.5 493 446q-45 113-8 204-79 87-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-39 36-49 103-21 10-45 15t-57 5-65.5-21.5T484 1274q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 88.5t.5 54.5q0 18-13 30t-40 7q-232-77-378.5-277.5T128 896q0-209 103-385.5T510.5 231 896 128zM419 1231q3-7-7-12-10-3-13 2-3 7 7 12 9 6 13-2zm31 34q7-5-2-16-10-9-16-3-7 5 2 16 10 10 16 3zm30 45q9-7 0-19-8-13-17-6-9 5 0 18t17 7zm42 42q8-8-4-19-12-12-20-3-9 8 4 19 12 12 20 3zm57 25q3-11-13-16-15-4-19 7t13 15q15 6 19-6zm63 5q0-13-17-11-16 0-16 11 0 13 17 11 16 0 16-11zm58-10q-2-11-18-9-16 3-14 15t18 8 14-14z"/></svg></a><a href=https://www.linkedin.com/in/mikeseddonau/ target=_blank><svg width="22" height="22" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M365 1414h231V720H365v694zm246-908q-1-52-36-86t-93-34-94.5 34-36.5 86q0 51 35.5 85.5T479 626h1q59 0 95-34.5t36-85.5zm585 908h231v-398q0-154-73-233t-193-79q-136 0-209 117h2V720H723q3 66 0 694h231v-388q0-38 7-56 15-35 45-59.5t74-24.5q116 0 116 157v371zm468-998v960q0 119-84.5 203.5T1376 1664H416q-119 0-203.5-84.5T128 1376V416q0-119 84.5-203.5T416 128h960q119 0 203.5 84.5T1664 416z"/></svg></a></p></div></section><ul></ul></section><section id=content><h1>Computing WikiPedia&#39;s internal PageRank with Apache Spark</h1><div id=sub-header>14 November 2015</div><div class=entry-content><p>Recently I have spent a lot of time reading and learning about graphs and graph analytics which naturally drew me to <a href=https://spark.apache.org/graphx/>Apache Spark GraphX</a> having previously played with <a href=http://neo4j.com/>Neo4J</a>. The benefits of GraphX are:</p><ul><li>fully open source</li><li>scalable using the Apache Spark model</li><li>written in Scala which I have been meaning to learn</li><li>already has basic graph algorithms such as <a href=https://en.wikipedia.org/wiki/PageRank>PageRank</a></li></ul><p>There is a great resource for learning the basics of Apache Spark provided by Berkeley&rsquo;s <a href=http://ampcamp.berkeley.edu/>AMP Camp</a> where you can follow very well documented tutorials including one on calculating PageRank on very small subset of Wikipedia data which has been preprocessed by them to simply the tutorials. This post extends their tutorial to loading a full set of Wikipedia&rsquo;s most recent backup to the point of executing the PageRank.</p><h3 id=1-know-your-data>1. Know your data</h3><p>The first step is to understand the file formats available from <a href=https://en.wikipedia.org/wiki/Wikipedia:Database_download>WikiPedia&rsquo;s Database Backups</a>. WikiPedia uses <a href=https://mariadb.com/>MariaDB</a> and does a full database dump at the start of each month. These backups are getting very large but fortunately to calculate PageRank we only need two of the many files:</p><ul><li><code>enwiki-20151002-page.sql.gz</code> (1.2GB) which stores the unique id, titles and metadata for each WikiPedia page</li><li><code>enwiki-20151002-pagelinks.sql.gz</code> (4.6 GB) which stores the links between internal WikiPedia pages
These files are provided already gzipped which makes them slightly more manageable. I have unzipped them both and stripped out some sample data so that this tutorial can work.</li></ul><p>The files contain a lot of metadata and MySQL commands which we don&rsquo;t want as we are only interested in the rows which start with <code>INSERT INTO</code>. We still need to be able handle all the other rows as I am lazy and don&rsquo;t want to manually edit the text files each time I load the data - particularly when the raw <code>enwiki-20151002-pagelinks.sql</code> file is around 35GB uncompressed.</p><p>For this example I have heavily modified these files to extract records which are going to create a micrograph for testing based around Nirvana&rsquo;s 1991 album <a href=https://en.wikipedia.org/wiki/Nevermind>Nevermind</a>.</p><p>Here is the minified <code>page</code> table extract. You can save this file as <code>enwiki-20151002-page-sm.sql</code>.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=c1>-- MySQL dump 10.13  Distrib 5.5.44, for debian-linux-gnu (x86_64)
</span><span class=c1>--
</span><span class=c1>-- Host: 10.64.32.23    Database: enwiki
</span><span class=c1>-- ------------------------------------------------------
</span><span class=c1>-- Server version	5.5.5-10.0.16-MariaDB-log
</span><span class=c1></span>
<span class=cm>/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */</span><span class=p>;</span>
<span class=cm>/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */</span><span class=p>;</span>
<span class=cm>/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */</span><span class=p>;</span>
<span class=cm>/*!40101 SET NAMES utf8 */</span><span class=p>;</span>
<span class=cm>/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */</span><span class=p>;</span>
<span class=cm>/*!40103 SET TIME_ZONE=&#39;+00:00&#39; */</span><span class=p>;</span>
<span class=cm>/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */</span><span class=p>;</span>
<span class=cm>/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */</span><span class=p>;</span>
<span class=cm>/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&#39;NO_AUTO_VALUE_ON_ZERO&#39; */</span><span class=p>;</span>
<span class=cm>/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */</span><span class=p>;</span>

<span class=c1>--
</span><span class=c1>-- Table structure for table `page`
</span><span class=c1>--
</span><span class=c1></span>
<span class=k>DROP</span> <span class=k>TABLE</span> <span class=k>IF</span> <span class=k>EXISTS</span> <span class=o>`</span><span class=n>page</span><span class=o>`</span><span class=p>;</span>
<span class=cm>/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span class=p>;</span>
<span class=cm>/*!40101 SET character_set_client = utf8 */</span><span class=p>;</span>
<span class=k>CREATE</span> <span class=k>TABLE</span> <span class=o>`</span><span class=n>page</span><span class=o>`</span> <span class=p>(</span>
  <span class=o>`</span><span class=n>page_id</span><span class=o>`</span> <span class=nb>int</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=n>unsigned</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=n>AUTO_INCREMENT</span><span class=p>,</span>
  <span class=o>`</span><span class=n>page_namespace</span><span class=o>`</span> <span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
  <span class=o>`</span><span class=n>page_title</span><span class=o>`</span> <span class=n>varbinary</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
  <span class=o>`</span><span class=n>page_restrictions</span><span class=o>`</span> <span class=n>tinyblob</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>page_counter</span><span class=o>`</span> <span class=nb>bigint</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span> <span class=n>unsigned</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
  <span class=o>`</span><span class=n>page_is_redirect</span><span class=o>`</span> <span class=n>tinyint</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=n>unsigned</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
  <span class=o>`</span><span class=n>page_is_new</span><span class=o>`</span> <span class=n>tinyint</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=n>unsigned</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
  <span class=o>`</span><span class=n>page_random</span><span class=o>`</span> <span class=n>double</span> <span class=n>unsigned</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
  <span class=o>`</span><span class=n>page_touched</span><span class=o>`</span> <span class=n>varbinary</span><span class=p>(</span><span class=mi>14</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
  <span class=o>`</span><span class=n>page_links_updated</span><span class=o>`</span> <span class=n>varbinary</span><span class=p>(</span><span class=mi>14</span><span class=p>)</span> <span class=k>DEFAULT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>page_latest</span><span class=o>`</span> <span class=nb>int</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=n>unsigned</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
  <span class=o>`</span><span class=n>page_len</span><span class=o>`</span> <span class=nb>int</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=n>unsigned</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
  <span class=o>`</span><span class=n>page_content_model</span><span class=o>`</span> <span class=n>varbinary</span><span class=p>(</span><span class=mi>32</span><span class=p>)</span> <span class=k>DEFAULT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=k>PRIMARY</span> <span class=k>KEY</span> <span class=p>(</span><span class=o>`</span><span class=n>page_id</span><span class=o>`</span><span class=p>),</span>
  <span class=k>UNIQUE</span> <span class=k>KEY</span> <span class=o>`</span><span class=n>name_title</span><span class=o>`</span> <span class=p>(</span><span class=o>`</span><span class=n>page_namespace</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>page_title</span><span class=o>`</span><span class=p>),</span>
  <span class=k>KEY</span> <span class=o>`</span><span class=n>page_random</span><span class=o>`</span> <span class=p>(</span><span class=o>`</span><span class=n>page_random</span><span class=o>`</span><span class=p>),</span>
  <span class=k>KEY</span> <span class=o>`</span><span class=n>page_len</span><span class=o>`</span> <span class=p>(</span><span class=o>`</span><span class=n>page_len</span><span class=o>`</span><span class=p>),</span>
  <span class=k>KEY</span> <span class=o>`</span><span class=n>page_redirect_namespace_len</span><span class=o>`</span> <span class=p>(</span><span class=o>`</span><span class=n>page_is_redirect</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>page_namespace</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>page_len</span><span class=o>`</span><span class=p>)</span>
<span class=p>)</span> <span class=n>ENGINE</span><span class=o>=</span><span class=n>InnoDB</span> <span class=n>AUTO_INCREMENT</span><span class=o>=</span><span class=mi>48043691</span> <span class=k>DEFAULT</span> <span class=n>CHARSET</span><span class=o>=</span><span class=nb>binary</span><span class=p>;</span>
<span class=cm>/*!40101 SET character_set_client = @saved_cs_client */</span><span class=p>;</span>

<span class=c1>--
</span><span class=c1>-- Dumping data for table `page`
</span><span class=c1>--
</span><span class=c1></span>
<span class=cm>/*!40000 ALTER TABLE `page` DISABLE KEYS */</span><span class=p>;</span>
<span class=k>INSERT</span> <span class=k>INTO</span> <span class=o>`</span><span class=n>page</span><span class=o>`</span> <span class=k>VALUES</span> <span class=p>(</span><span class=mi>143294</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;Nevermind&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=mi>184</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>.</span><span class=mi>0731898286130185</span><span class=p>,</span><span class=s1>&#39;20150930071645&#39;</span><span class=p>,</span><span class=s1>&#39;20150930071645&#39;</span><span class=p>,</span><span class=mi>683430869</span><span class=p>,</span><span class=mi>59319</span><span class=p>,</span><span class=s1>&#39;wikitext&#39;</span><span class=p>),(</span><span class=mi>143978</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;Nirvana\&#39;</span><span class=n>s_Smells_Like_Teen_Spirit</span><span class=s1>&#39;,&#39;&#39;,5,1,0,0.5825380967767331,&#39;</span><span class=mi>20150930063333</span><span class=s1>&#39;,NULL,132735942,38,&#39;</span><span class=n>wikitext</span><span class=s1>&#39;),(1056254,0,&#39;</span><span class=n>In_Bloom</span><span class=s1>&#39;,&#39;&#39;,0,0,0,0.6394936561769999,&#39;</span><span class=mi>20150930070821</span><span class=s1>&#39;,&#39;</span><span class=mi>20150930070821</span><span class=s1>&#39;,683429998,15190,&#39;</span><span class=n>wikitext</span><span class=s1>&#39;);
</span><span class=s1>INSERT INTO `page` VALUES (1055714,0,&#39;</span><span class=n>Come_as_You_Are_</span><span class=p>(</span><span class=n>Nirvana_song</span><span class=p>)</span><span class=s1>&#39;,&#39;&#39;,0,0,0,0.831843581904,&#39;</span><span class=mi>20151003185132</span><span class=s1>&#39;,&#39;</span><span class=mi>20151003185132</span><span class=s1>&#39;,683970810,17998,&#39;</span><span class=n>wikitext</span><span class=s1>&#39;),(1069194,0,&#39;</span><span class=n>Lithium_</span><span class=p>(</span><span class=n>Nirvana_song</span><span class=p>)</span><span class=s1>&#39;,&#39;&#39;,0,0,0,0.609460954838,&#39;</span><span class=mi>20150930070554</span><span class=s1>&#39;,&#39;</span><span class=mi>20150930070554</span><span class=s1>&#39;,683429758,12444,&#39;</span><span class=n>wikitext</span><span class=s1>&#39;);
</span><span class=s1>/*!40000 ALTER TABLE `page` ENABLE KEYS */;
</span><span class=s1>/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;
</span><span class=s1>
</span><span class=s1>/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
</span><span class=s1>/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
</span><span class=s1>/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
</span><span class=s1>/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
</span><span class=s1>/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
</span><span class=s1>/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
</span><span class=s1>/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;
</span><span class=s1>
</span><span class=s1>-- Dump completed on 2015-10-04 10:11:57</span></code></pre></div><p>Here is the minified <code>pagelinks</code> table extract. You can save this file as <code>enwiki-20151002-pagelinks-sm.sql</code>.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=c1>-- MySQL dump 10.13  Distrib 5.5.44, for debian-linux-gnu (x86_64)
</span><span class=c1>--
</span><span class=c1>-- Host: 10.64.32.23    Database: enwiki
</span><span class=c1>-- ------------------------------------------------------
</span><span class=c1>-- Server version	5.5.5-10.0.16-MariaDB-log
</span><span class=c1></span>
<span class=cm>/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */</span><span class=p>;</span>
<span class=cm>/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */</span><span class=p>;</span>
<span class=cm>/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */</span><span class=p>;</span>
<span class=cm>/*!40101 SET NAMES utf8 */</span><span class=p>;</span>
<span class=cm>/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */</span><span class=p>;</span>
<span class=cm>/*!40103 SET TIME_ZONE=&#39;+00:00&#39; */</span><span class=p>;</span>
<span class=cm>/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */</span><span class=p>;</span>
<span class=cm>/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */</span><span class=p>;</span>
<span class=cm>/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&#39;NO_AUTO_VALUE_ON_ZERO&#39; */</span><span class=p>;</span>
<span class=cm>/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */</span><span class=p>;</span>

<span class=c1>--
</span><span class=c1>-- Table structure for table `pagelinks`
</span><span class=c1>--
</span><span class=c1></span>
<span class=k>DROP</span> <span class=k>TABLE</span> <span class=k>IF</span> <span class=k>EXISTS</span> <span class=o>`</span><span class=n>pagelinks</span><span class=o>`</span><span class=p>;</span>
<span class=cm>/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span class=p>;</span>
<span class=cm>/*!40101 SET character_set_client = utf8 */</span><span class=p>;</span>
<span class=k>CREATE</span> <span class=k>TABLE</span> <span class=o>`</span><span class=n>pagelinks</span><span class=o>`</span> <span class=p>(</span>
  <span class=o>`</span><span class=n>pl_from</span><span class=o>`</span> <span class=nb>int</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=n>unsigned</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
  <span class=o>`</span><span class=n>pl_namespace</span><span class=o>`</span> <span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
  <span class=o>`</span><span class=n>pl_title</span><span class=o>`</span> <span class=n>varbinary</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
  <span class=o>`</span><span class=n>pl_from_namespace</span><span class=o>`</span> <span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>DEFAULT</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
  <span class=k>UNIQUE</span> <span class=k>KEY</span> <span class=o>`</span><span class=n>pl_from</span><span class=o>`</span> <span class=p>(</span><span class=o>`</span><span class=n>pl_from</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>pl_namespace</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>pl_title</span><span class=o>`</span><span class=p>),</span>
  <span class=k>KEY</span> <span class=o>`</span><span class=n>pl_namespace</span><span class=o>`</span> <span class=p>(</span><span class=o>`</span><span class=n>pl_namespace</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>pl_title</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>pl_from</span><span class=o>`</span><span class=p>),</span>
  <span class=k>KEY</span> <span class=o>`</span><span class=n>pl_backlinks_namespace</span><span class=o>`</span> <span class=p>(</span><span class=o>`</span><span class=n>pl_from_namespace</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>pl_namespace</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>pl_title</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>pl_from</span><span class=o>`</span><span class=p>)</span>
<span class=p>)</span> <span class=n>ENGINE</span><span class=o>=</span><span class=n>InnoDB</span> <span class=k>DEFAULT</span> <span class=n>CHARSET</span><span class=o>=</span><span class=nb>binary</span><span class=p>;</span>
<span class=cm>/*!40101 SET character_set_client = @saved_cs_client */</span><span class=p>;</span>

<span class=c1>--
</span><span class=c1>-- Dumping data for table `pagelinks`
</span><span class=c1>--
</span><span class=c1></span>
<span class=cm>/*!40000 ALTER TABLE `pagelinks` DISABLE KEYS */</span><span class=p>;</span>
<span class=k>INSERT</span> <span class=k>INTO</span> <span class=o>`</span><span class=n>pagelinks</span><span class=o>`</span> <span class=k>VALUES</span> <span class=p>(</span><span class=mi>143294</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;Come_as_You_Are_(Nirvana_song)&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>),(</span><span class=mi>143294</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;Smells_Like_Teen_Spirit&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>),(</span><span class=mi>143294</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;Lithium_(Nirvana_song)&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
<span class=k>INSERT</span> <span class=k>INTO</span> <span class=o>`</span><span class=n>pagelinks</span><span class=o>`</span> <span class=k>VALUES</span> <span class=p>(</span><span class=mi>143294</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;In_Bloom&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>),(</span><span class=mi>143294</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;Polly_(song)&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
<span class=cm>/*!40000 ALTER TABLE `pagelinks` ENABLE KEYS */</span><span class=p>;</span>
<span class=cm>/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */</span><span class=p>;</span>

<span class=cm>/*!40101 SET SQL_MODE=@OLD_SQL_MODE */</span><span class=p>;</span>
<span class=cm>/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */</span><span class=p>;</span>
<span class=cm>/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */</span><span class=p>;</span>
<span class=cm>/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */</span><span class=p>;</span>
<span class=cm>/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */</span><span class=p>;</span>
<span class=cm>/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */</span><span class=p>;</span>
<span class=cm>/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */</span><span class=p>;</span>

<span class=c1>-- Dump completed on 2015-10-04  7:20:12</span></code></pre></div><p>From these files we have learnt:</p><ul><li>if we can use the gzipped versions we will be able to reduce network volume and disk storage requirements*</li><li>we need a way of handling rows we don&rsquo;t care about (e.g. <code>CREATE TABLE</code> commands).</li><li>we need a method for extracting one or more records on each line</li><li>we need a way of selecting only the WikiPedia <a href=https://meta.wikimedia.org/wiki/Help:Namespace>namespaces</a> that are in scope</li><li>WikiPedia&rsquo;s <code>pagelinks</code> uses two different types of keys: a numeric key (<code>pl_from</code>) for the source <code>page</code> and a string key (<code>pl_title</code>) referring to the target&rsquo;s <code>page</code> title so we are going to have to do a bit of work to normalise it. This can be confirmed by viewing WikiPedia&rsquo;s <a href=https://www.mediawiki.org/wiki/Manual:Pagelinks_table>pagelinks</a> documentation</li><li>because we have the <code>CREATE TABLE</code> statements we can see field definitions including name and datatypes which will come in handy. WikiPedia also provides <a href=https://en.wikipedia.org/wiki/MediaWiki>full documentation</a> on their database structure</li><li>these strings are huge so we need to manage this in a way which will not cause out of memory issues</li></ul><h3 id=2-load-the-files>2. Load the Files</h3><p>Copy the two files from the previous step to somewhere on your filesystem that can be accessed by your Apache Spark process. For development we are going to execute these Scala scripts using the <code>bin/spark-shell</code> utility:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>bin/spark-shell -i filename.scala</code></pre></div><h4 id=2-1-setting-up>2.1 Setting up</h4><p>First I am going to define my imports and a timestamp which we will use later to see how performant this code is.</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=k>import</span> <span class=nn>org.apache.spark.graphx._</span>
<span class=k>import</span> <span class=nn>org.apache.spark.rdd.RDD</span>

<span class=k>val</span> <span class=n>timestampStart</span><span class=k>:</span> <span class=kt>Long</span> <span class=o>=</span> <span class=nc>System</span><span class=o>.</span><span class=n>currentTimeMillis</span></code></pre></div><h4 id=2-2-load-and-parse-the-data>2.2 Load and Parse the Data</h4><p>Define the RDDs which read the text files from the disk. Currently we are using the minified files which I created and pasted above but the SparkContext is smart enough to be able to read gzipped files which meets the first of our requirements.</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=c1>// Load the textFiles as RDD. Spark will auto-partition
</span><span class=c1></span><span class=k>val</span> <span class=n>page</span><span class=k>:</span> <span class=kt>RDD</span><span class=o>[</span><span class=kt>String</span><span class=o>]</span> <span class=k>=</span> <span class=n>sc</span><span class=o>.</span><span class=n>textFile</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=n>data</span><span class=o>/</span><span class=n>wiki</span><span class=o>/</span><span class=n>enwiki</span><span class=o>-</span><span class=mi>20151002</span><span class=o>-</span><span class=n>page</span><span class=o>-</span><span class=n>sm</span><span class=o>.</span><span class=n>sql</span><span class=s>&#34;&#34;</span><span class=o>)</span>
<span class=k>val</span> <span class=n>pagelink</span><span class=k>:</span> <span class=kt>RDD</span><span class=o>[</span><span class=kt>String</span><span class=o>]</span> <span class=k>=</span> <span class=n>sc</span><span class=o>.</span><span class=n>textFile</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=n>data</span><span class=o>/</span><span class=n>wiki</span><span class=o>/</span><span class=n>enwiki</span><span class=o>-</span><span class=mi>20151002</span><span class=o>-</span><span class=n>pagelinks</span><span class=o>-</span><span class=n>sm</span><span class=o>.</span><span class=n>sql</span><span class=s>&#34;&#34;</span><span class=o>)</span></code></pre></div><p>From the AMP Camp example we know we can read a RDD[String] by calling the <code>map</code> function which will operate over each line. This means if we can work out a way to check each line to see if it contains the INSERT INTO data we care about we can meet our second requirement. My answer is to use regex to perform a pattern match to see if any relevant data appears on each line. The beauty of using regex is that it can meet multiple requirements at once:</p><ul><li>we can easily ignore rows that do not contain relevant data</li><li>we can use it to extract one or multiple records from each line</li><li>we can use it to filter out only the records in the namespace that we care about</li></ul><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=c1>// Define the REGEX to scrape from the page MySQL dump
</span><span class=c1></span><span class=k>val</span> <span class=n>pagePattern</span> <span class=k>=</span> <span class=s>&#34;&#34;</span><span class=n>\\</span><span class=o>((</span><span class=n>\\d</span><span class=o>*),</span><span class=mi>0</span><span class=o>,</span><span class=err>&#39;</span><span class=o>([</span><span class=kt>^</span>,<span class=o>]*?)</span><span class=sc>&#39;,&#39;</span><span class=o>.*?\\)+[</span>,<span class=kt>|</span><span class=err>;</span><span class=o>]</span><span class=s>&#34;&#34;</span><span class=o>.</span><span class=n>r</span></code></pre></div><p>This expression will:</p><ul><li>find text which starts with a <code>(</code> and ends with a <code>)</code> followed by either a <code>,</code> or <code>;</code></li><li>within that text find and capture a series of digits (<code>\d</code>) directly following the opening <code>(</code> which is the <code>page_id</code> field</li><li>make sure that after that initial number there is a <code>,0,</code> which will filter the records by the <code>page_namespace</code> field for only <code>0</code> which is the <code>main</code> namespace</li><li>find an extract all data between the <code>'</code> characters which is the <code>page_title</code> field</li></ul><p>To execute this against the dataset we want to use the same expression in two ways:</p><ul><li>first <code>findAllMatchIn</code> will search and extract all the matches for a single <code>line</code> and place them into an array called <code>matches</code>. This means if a line has multiple records on it they will all be extracted individually and stored in an array for that line. It also means that any line which does not have a matching pattern will be ignored.</li><li>then for each match in the <code>matches</code> array map the extracted values (the <code>page_id</code> and <code>page_title</code> values) to store them in the pageRDD RDD[(String, Long)].</li></ul><p>This code uses a <code>flatMap</code> instead of <code>map</code> of each line in the input file as we are expecting one line to produce one or more output objects and <code>map</code> will not work with more than one result. I am not sure of the performance impact of using <code>flatMap</code> everywhere instead of <code>map</code> as a issue preventative measure but presumably there is enough impact or there would not be two methods.</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=c1>// Extract the page data into the pageRDD
</span><span class=c1></span><span class=k>val</span> <span class=n>pageRDD</span><span class=k>:</span> <span class=kt>RDD</span><span class=o>[(</span><span class=kt>String</span>, <span class=kt>Long</span><span class=o>)]</span> <span class=k>=</span> <span class=n>page</span><span class=o>.</span><span class=n>flatMap</span> <span class=o>{</span> <span class=n>line</span> <span class=k>=&gt;</span>
  <span class=k>val</span> <span class=n>matches</span> <span class=k>=</span> <span class=n>pagePattern</span><span class=o>.</span><span class=n>findAllMatchIn</span><span class=o>(</span><span class=n>line</span><span class=o>).</span><span class=n>toArray</span>
  <span class=n>matches</span><span class=o>.</span><span class=n>map</span> <span class=o>{</span> <span class=n>d</span> <span class=k>=&gt;</span>
    <span class=c1>// &#34;&#34;page_title&#34;&#34;,&#34;&#34;page_id&#34;&#34;
</span><span class=c1></span>    <span class=o>(</span><span class=n>d</span><span class=o>.</span><span class=n>group</span><span class=o>(</span><span class=mi>2</span><span class=o>),</span> <span class=n>d</span><span class=o>.</span><span class=n>group</span><span class=o>(</span><span class=mi>1</span><span class=o>).</span><span class=n>toLong</span><span class=o>)</span>
  <span class=o>}</span>
<span class=o>}.</span><span class=n>setName</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=n>pageRDD</span><span class=s>&#34;&#34;</span><span class=o>).</span><span class=n>cache</span><span class=o>()</span></code></pre></div><p>You can see that I am not storing the values in a using the conventional primary key <code>page_id</code> then value <code>page_title</code> like a relational database design but I have actually stored the <code>page_title</code> first. This is because I need to use the <code>page_title</code> field to join from my <code>pagelinks</code> dataset and the RDD <code>join</code> method requires keys to be in the first field.</p><p>Finally I also use the <code>setName</code> method to apply a nice name which will show up in the Spark Application browser so I can easily work out which RDD is stored in memory.</p><p>The <code>pagelinks</code> data is processed in much the same way but in this case a slightly different regex is used as we want only the records which have a target <code>pl_namespace = 0</code> and <code>pl_from_namespace = 0</code>.</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=c1>// Define the REGEX to scrape from the pagelinks MySQL dump
</span><span class=c1></span><span class=k>val</span> <span class=n>pagelinksPattern</span> <span class=k>=</span> <span class=s>&#34;&#34;</span><span class=n>\\</span><span class=o>((</span><span class=n>\\d</span><span class=o>*),</span><span class=mi>0</span><span class=o>,</span><span class=err>&#39;</span><span class=o>([</span><span class=kt>^</span>,<span class=o>]*?)</span><span class=err>&#39;</span><span class=o>,</span><span class=mi>0</span><span class=n>\\</span><span class=o>)+[</span>,<span class=kt>|</span><span class=err>;</span><span class=o>]</span><span class=s>&#34;&#34;</span><span class=o>.</span><span class=n>r</span>
<span class=c1>// Extract the pagelink data into the pagelinksRDD
</span><span class=c1></span><span class=k>val</span> <span class=n>pagelinksRDD</span><span class=k>:</span> <span class=kt>RDD</span><span class=o>[(</span><span class=kt>String</span>, <span class=kt>Long</span><span class=o>)]</span> <span class=k>=</span> <span class=n>pagelink</span><span class=o>.</span><span class=n>flatMap</span> <span class=o>{</span> <span class=n>line</span> <span class=k>=&gt;</span>
  <span class=k>val</span> <span class=n>matches</span> <span class=k>=</span> <span class=n>pagelinksPattern</span><span class=o>.</span><span class=n>findAllMatchIn</span><span class=o>(</span><span class=n>line</span><span class=o>).</span><span class=n>toArray</span>
  <span class=n>matches</span><span class=o>.</span><span class=n>map</span> <span class=o>{</span> <span class=n>d</span> <span class=k>=&gt;</span>
    <span class=c1>// &#34;&#34;pl_title&#34;&#34;,&#34;&#34;pl_from&#34;&#34;
</span><span class=c1></span>    <span class=o>(</span><span class=n>d</span><span class=o>.</span><span class=n>group</span><span class=o>(</span><span class=mi>2</span><span class=o>),</span> <span class=n>d</span><span class=o>.</span><span class=n>group</span><span class=o>(</span><span class=mi>1</span><span class=o>).</span><span class=n>toLong</span><span class=o>)</span>
  <span class=o>}</span>
<span class=o>}.</span><span class=n>setName</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=n>pagelinksRDD</span><span class=s>&#34;&#34;</span><span class=o>).</span><span class=n>cache</span><span class=o>()</span></code></pre></div><p>To see that this has worked you can execute these commands:</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=c1>// Show number of records in each RDD
</span><span class=c1></span><span class=n>println</span><span class=o>(</span><span class=s>s&#34;&#34;</span><span class=n>pageRDD</span><span class=k>:</span> <span class=err>&#34;&#34;</span><span class=kt>+pageRDD.count</span><span class=o>())</span>
<span class=n>println</span><span class=o>(</span><span class=s>s&#34;&#34;</span><span class=n>pagelinksRDD</span><span class=k>:</span> <span class=err>&#34;&#34;</span><span class=kt>+pagelinksRDD.count</span><span class=o>())</span></code></pre></div><p>of if you want to see the first 10 records of the data in the shell:</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=c1>// Show the first 10 records of each RDD
</span><span class=c1></span><span class=n>pageRDD</span><span class=o>.</span><span class=n>take</span><span class=o>(</span><span class=mi>10</span><span class=o>)</span>
<span class=n>pagelinksRDD</span><span class=o>.</span><span class=n>take</span><span class=o>(</span><span class=mi>10</span><span class=o>)</span></code></pre></div><h3 id=3-join-the-data>3. Join the Data</h3><p>So we have used regex to do the heavy lifting and extract the data into nice RDDs but we still have the problem of the two different types of keys in the <code>pagelinks</code> dataset (one numeric and one string). This means we need to do a join from the <code>pagelinksRDD</code> to the <code>pageRDD</code> using the <code>page_title</code> and <code>pl_title</code> as keys.</p><p>For example, we need to join join page <code>143294</code> to page <code>1055714</code> using <code>Come_as_You_Are_(Nirvana_song)</code> as our join key.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=c1>-- enwiki-20151002-pagelinks-sm.sql
</span><span class=c1></span><span class=p>(</span><span class=mi>143294</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;Come_as_You_Are_(Nirvana_song)&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>)</span>

<span class=c1>-- enwiki-20151002-page-sm.sql
</span><span class=c1></span><span class=p>(</span><span class=mi>143294</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;Nevermind&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=mi>184</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>.</span><span class=mi>0731898286130185</span><span class=p>,</span><span class=s1>&#39;20150930071645&#39;</span><span class=p>,</span><span class=s1>&#39;20150930071645&#39;</span><span class=p>,</span><span class=mi>683430869</span><span class=p>,</span><span class=mi>59319</span><span class=p>,</span><span class=s1>&#39;wikitext&#39;</span><span class=p>)</span>
<span class=p>(</span><span class=mi>1055714</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;Come_as_You_Are_(Nirvana_song)&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>.</span><span class=mi>831843581904</span><span class=p>,</span><span class=s1>&#39;20151003185132&#39;</span><span class=p>,</span><span class=s1>&#39;20151003185132&#39;</span><span class=p>,</span><span class=mi>683970810</span><span class=p>,</span><span class=mi>17998</span><span class=p>,</span><span class=s1>&#39;wikitext&#39;</span><span class=p>)</span></code></pre></div><p>So here you have a choice. You can either continue using Scala or you can use SparkSQL commands.</p><h5 id=3-1-sparksql>3.1. SparkSQL</h5><p>Initially I used SparkSQL as I have a lot more experience using SQL than Scala (and I am sure this applies to most of you). The benefits of this approach is that SQL is so ingrained that you don&rsquo;t really have to think to write it. Also, Spark has such a nice API and has heavily optimised dataframes.</p><p>The first step is to convert the <code>pageRDD</code> and <code>pagelinksRDD</code> to datafames with <code>.toDF()</code>. You then need to call <code>registerTempTable</code> to register them with SparkSQL.</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=c1>// Convert the pageRDD and pagelinksRDD to DataFrames and register them with the sqlContext
</span><span class=c1></span><span class=n>pageRDD</span><span class=o>.</span><span class=n>toDF</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=n>page_title</span><span class=s>&#34;&#34;</span><span class=o>,</span><span class=s>&#34;&#34;</span><span class=n>page_id</span><span class=s>&#34;&#34;</span><span class=o>).</span><span class=n>registerTempTable</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=n>page</span><span class=s>&#34;&#34;</span><span class=o>)</span>
<span class=n>pagelinksRDD</span><span class=o>.</span><span class=n>toDF</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=n>pl_title</span><span class=s>&#34;&#34;</span><span class=o>,</span><span class=s>&#34;&#34;</span><span class=n>pl_from</span><span class=s>&#34;&#34;</span><span class=o>).</span><span class=n>registerTempTable</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=n>pagelinks</span><span class=s>&#34;&#34;</span><span class=o>)</span></code></pre></div><p>When we called the <code>.toDF()</code> method we also passed the field names so that the SQLContext will already have the metadata (read: field names and types) available for querying and so this very simple SQL query will work:</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=k>val</span> <span class=n>pagelinksDF</span> <span class=k>=</span> <span class=n>sqlContext</span><span class=o>.</span><span class=n>sql</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=nc>SELECT</span> <span class=n>pagelinks</span><span class=o>.</span><span class=n>pl_from</span> <span class=n>as</span> <span class=n>srcId</span><span class=o>,</span> <span class=n>page</span><span class=o>.</span><span class=n>page_id</span> <span class=n>as</span> <span class=n>tgtId</span><span class=o>,</span> <span class=mi>0</span> <span class=n>as</span> <span class=n>attr</span> <span class=nc>FROM</span> <span class=n>pagelinks</span> <span class=nc>INNER</span> <span class=nc>JOIN</span> <span class=n>page</span> <span class=nc>ON</span> <span class=n>pagelinks</span><span class=o>.</span><span class=n>pl_title</span> <span class=k>=</span> <span class=n>page</span><span class=o>.</span><span class=n>page_title</span><span class=s>&#34;&#34;</span><span class=o>)</span></code></pre></div><p>Now we have a result set it is easy enough to map it to the <code>org.apache.spark.graphx.Edge</code> class.</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=k>val</span> <span class=n>edges</span> <span class=k>=</span> <span class=n>pagelinksDF</span><span class=o>.</span><span class=n>map</span> <span class=o>{</span> <span class=n>pagelink</span> <span class=k>=&gt;</span>
    <span class=nc>Edge</span><span class=o>(</span><span class=n>pagelink</span><span class=o>.</span><span class=n>getLong</span><span class=o>(</span><span class=mi>0</span><span class=o>),</span> <span class=n>pagelink</span><span class=o>.</span><span class=n>getLong</span><span class=o>(</span><span class=mi>1</span><span class=o>),</span> <span class=n>pagelink</span><span class=o>.</span><span class=n>getInt</span><span class=o>(</span><span class=mi>2</span><span class=o>))</span>
<span class=o>}.</span><span class=n>setName</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=n>edges</span><span class=s>&#34;&#34;</span><span class=o>).</span><span class=n>cache</span><span class=o>()</span></code></pre></div><h5 id=3-2-scala>3.2. Scala</h5><p>If we want to use Scala and do it we need to use the <code>join</code> method. <code>join</code> requires that the join keys are in the first field of the two datasets to be joined but as we have prepared the data in this way already we can go ahead an join in one command:</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=c1>// Join the RDDs using the title as the key and map the objects to the Edge object
</span><span class=c1></span><span class=k>val</span> <span class=n>edges</span> <span class=k>=</span> <span class=n>pageRDD</span><span class=o>.</span><span class=n>join</span><span class=o>(</span><span class=n>pagelinksRDD</span><span class=o>).</span><span class=n>map</span> <span class=o>{</span>
  <span class=k>case</span> <span class=o>(</span><span class=n>title</span><span class=o>,</span> <span class=o>(</span><span class=n>page_id</span><span class=o>,</span> <span class=n>pl_from</span><span class=o>))</span> <span class=k>=&gt;</span> <span class=nc>Edge</span><span class=o>(</span><span class=n>pl_from</span><span class=o>,</span> <span class=n>page_id</span><span class=o>,</span> <span class=mi>0</span><span class=o>)</span>
<span class=o>}.</span><span class=n>setName</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=n>edges</span><span class=s>&#34;&#34;</span><span class=o>).</span><span class=n>cache</span><span class=o>()</span></code></pre></div><p>If we hadn&rsquo;t organised our data with the key in the first fields then we would either have to remap the data so it was correctly ordered or we could call the <code>keyBy</code> function. This function will map each object so that it is a <code>(key, value)</code> pair where the key is the value passed into the function and the value is the original object. By doing the prework in the initial text reader we have saved a lot of unnecessary remapping and also reduce storage requirements as we are not storing the <code>pl_title</code> twice.</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=k>val</span> <span class=n>pagelinksRDDKeyByTitle</span> <span class=k>=</span> <span class=n>pagelinksRDD</span><span class=o>.</span><span class=n>keyBy</span><span class=o>(</span><span class=k>_</span><span class=o>.</span><span class=mi>2</span><span class=o>)</span>

<span class=c1>// pagelinksRDDKeyByTitle
</span><span class=c1></span><span class=o>(</span><span class=nc>Smells_Like_Teen_Spirit</span><span class=o>,(</span><span class=mi>143294</span><span class=o>,</span><span class=nc>Smells_Like_Teen_Spirit</span><span class=o>))</span></code></pre></div><h3 id=4-map-the-vertices>4. Map the Vertices</h3><p>So we have cleaned up the Edges now we can easily map the pageRDD to the correct <code>org.apache.spark.graphx.Vertex</code> format. All we are doing here swapping the order of the <code>page_id</code> and <code>page_title</code>.</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=c1>// Convert the pageRDD to the Vertex class
</span><span class=c1></span><span class=k>val</span> <span class=n>vertices</span> <span class=k>=</span> <span class=n>pageRDD</span><span class=o>.</span><span class=n>map</span> <span class=o>{</span> <span class=n>d</span> <span class=k>=&gt;</span>
    <span class=o>(</span><span class=n>d</span><span class=o>.</span><span class=n>_2</span><span class=o>,</span> <span class=n>d</span><span class=o>.</span><span class=n>_1</span><span class=o>)</span>
<span class=o>}.</span><span class=n>setName</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=n>vertices</span><span class=s>&#34;&#34;</span><span class=o>).</span><span class=n>cache</span><span class=o>()</span></code></pre></div><h3 id=5-generate-the-graph>5. Generate the Graph</h3><p>Now we have our datasets sorted we just need to create the graph. As the AMP Camp guys nicely point out, the third parameter of the Graph constructor is the default vertex value if an edge exists without a matching vertex. This will never happen in our case as we have inner joined the datasets explicitly in SQL:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=n>pagelinks</span> <span class=k>INNER</span> <span class=k>JOIN</span> <span class=n>page</span></code></pre></div><p>or by using the <code>join</code> RDD method:</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=n>pageRDDKeyByTitle</span><span class=o>.</span><span class=n>join</span><span class=o>(</span><span class=n>pagelinksRDDKeyByTitle</span><span class=o>)</span></code></pre></div><p>Both languages have the standard <code>LEFT JOIN</code>/<code>leftOuterJoin()</code> and <code>FULL OUTER JOIN</code>/<code>fullOuterJoin()</code> behaviours implemented if needed which might make the third <code>Graph</code> constructor parameter useful.</p><p>To build the graph:</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=k>val</span> <span class=n>graph</span> <span class=k>=</span> <span class=nc>Graph</span><span class=o>(</span><span class=n>vertices</span><span class=o>,</span> <span class=n>edges</span><span class=o>,</span> <span class=s>&#34;&#34;&#34;&#34;</span><span class=o>).</span><span class=n>setName</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=n>graph</span><span class=s>&#34;&#34;</span><span class=o>).</span><span class=n>cache</span><span class=o>()</span></code></pre></div><h3 id=6-run-pagerank>6. Run PageRank</h3><p>To execute the PageRank just call the pageRank function where the 0.001 is the error tolerance. I have shamelessly copied the code from AMP Camp for the output.</p><p>I also put an output to see how long the job ran for as it can help with performance tuning.</p><div class=highlight><pre class=chroma><code class=language-scala data-lang=scala><span class=k>val</span> <span class=n>prGraph</span> <span class=k>=</span> <span class=n>graph</span><span class=o>.</span><span class=n>pageRank</span><span class=o>(</span><span class=mf>0.001</span><span class=o>).</span><span class=n>cache</span><span class=o>()</span>

<span class=k>val</span> <span class=n>titleAndPrGraph</span> <span class=k>=</span> <span class=n>graph</span><span class=o>.</span><span class=n>outerJoinVertices</span><span class=o>(</span><span class=n>prGraph</span><span class=o>.</span><span class=n>vertices</span><span class=o>)</span> <span class=o>{</span>
  <span class=o>(</span><span class=n>v</span><span class=o>,</span> <span class=n>title</span><span class=o>,</span> <span class=n>rank</span><span class=o>)</span> <span class=k>=&gt;</span> <span class=o>(</span><span class=n>rank</span><span class=o>.</span><span class=n>getOrElse</span><span class=o>(</span><span class=mf>0.0</span><span class=o>),</span> <span class=n>title</span><span class=o>)</span>
<span class=o>}</span>

<span class=n>titleAndPrGraph</span><span class=o>.</span><span class=n>vertices</span><span class=o>.</span><span class=n>top</span><span class=o>(</span><span class=mi>10</span><span class=o>)</span> <span class=o>{</span>
  <span class=nc>Ordering</span><span class=o>.</span><span class=n>by</span><span class=o>((</span><span class=n>entry</span><span class=k>:</span> <span class=o>(</span><span class=kt>VertexId</span><span class=o>,</span> <span class=o>(</span><span class=kt>Double</span><span class=o>,</span> <span class=kt>String</span><span class=o>)))</span> <span class=k>=&gt;</span> <span class=n>entry</span><span class=o>.</span><span class=n>_2</span><span class=o>.</span><span class=n>_1</span><span class=o>)</span>
<span class=o>}.</span><span class=n>foreach</span><span class=o>(</span><span class=n>t</span> <span class=k>=&gt;</span> <span class=n>println</span><span class=o>(</span><span class=n>t</span><span class=o>.</span><span class=n>_2</span><span class=o>.</span><span class=n>_2</span> <span class=o>+</span> <span class=s>&#34;&#34;</span><span class=k>:</span> <span class=err>&#34;&#34;</span> <span class=kt>+</span> <span class=kt>t.</span><span class=k>_</span><span class=err>2</span><span class=kt>.</span><span class=k>_</span><span class=err>1</span><span class=o>))</span>

<span class=k>val</span> <span class=n>timestampEnd</span><span class=k>:</span> <span class=kt>Long</span> <span class=o>=</span> <span class=nc>System</span><span class=o>.</span><span class=n>currentTimeMillis</span>
<span class=k>val</span> <span class=n>duration</span><span class=k>:</span> <span class=kt>Long</span> <span class=o>=</span> <span class=n>timestampEnd</span> <span class=o>-</span> <span class=n>timestampStart</span>
<span class=n>println</span><span class=o>(</span><span class=s>s&#34;&#34;&#34;Duration: </span><span class=si>${</span><span class=n>duration</span><span class=si>}</span><span class=s> ms (~</span><span class=si>${</span><span class=n>duration</span><span class=o>/</span><span class=mi>1000</span><span class=o>/</span><span class=mi>60</span><span class=si>}</span><span class=s> minutes)&#34;&#34;&#34;</span><span class=o>)</span></code></pre></div></div><div id=links><a class="basic-alignment left" href=https://reorchestrate.com/posts/performance-tuning-spark-pagerank/>Performance Tuning Spark WikiPedia PageRank &raquo;</a></div></section></body></html>